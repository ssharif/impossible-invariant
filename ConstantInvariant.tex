\documentclass{amsart}
\usepackage{amsmath, amsthm, amssymb,latexsym,enumerate,mathrsfs}
\usepackage[all]{xy}
\usepackage{enumitem}
\usepackage{hyperref}
\usepackage{invariant}
\usepackage{xcolor}
\usepackage{tikz-cd}
\usepackage{verbatim}
\usepackage{lineno}
\linenumbers

\title[Invariants constant on unpolarized isomorphism classes]{Algebraic invariants constant on unpolarized isomorphism classes of abelian varieties}

%\author[E.\ Rains]{E.\ Rains}
%\address{}
%\email{}
%\author[?]{?}
%\address{}
%\email{}
%\author[A.\ Silverberg]{A.\ Silverberg}
%\address{Department of Mathematics, University of California, Irvine, CA 92697, USA}
%\email{asilverb@uci.edu}
%\subjclass[2010]{??}
%\keywords{abelian varieties}
%\thanks{Support for the research was provided by the Alfred P.~Sloan Foundation
%and the National Science Foundation.}

\begin{document}

\today
\tableofcontents
\maketitle

\section{Introduction}
\label{sec:introduction}

Let $\ag$ be the moduli space of principally polarized abelian varieties. If $A, B$ are abelian varieties, we say $A$ and $B$ are \emph{weakly isomorphic}, written $A \approx B$, if they are isomorphic as unpolarized abelian varieties. Our goal is to show the following.
\begin{theorem}\label{thm:invariant-c-constant}
  Suppose $R$ is a subring of $\C$. Let $f: \ag \to X$ be a morphism of $R$-schemes. If $f(A) = f(B)$ whenever $A \approx B$, then $f$ is constant.
\end{theorem}
Since a scheme over $\C$ is also scheme over $R$, it suffices to prove the theorem with $R = \C$. We will deduce the theorem as a corollary of another result, stated below.

Let $R$ be a scheme, and for an $R$-scheme $S$ write $S[R]$ to be the set
\[
  \dlim_{T/R} S(T)
\]
where the limit is over all $R$-schemes $T$. Let
\[
  \sg: \rschemes \to \mathcal{P}((\ag \times \ag)[R])
\]
be the functor from $R$-schemes to the power set of $(\ag \times \ag)[R]$ that sends an $R$-scheme $T$ to the set
\[
  \sg(T) = \{(A,B) \in (\ag \times \ag)(T) | A \approx B\}.
\]
Then we will show the following.
\begin{theorem}\label{thm:sg-c-dense}
  If $R$ is a subring of $\C$, then the set $\sg(R)$ is Zariski dense in the $R$-scheme $\ag \times \ag$.
\end{theorem}
As with Theorem~\ref{thm:invariant-c-constant}, it suffices to address the case where $R = \C$.

\paragraph{Overview.}

The idea is as follows. Choose a prime $\ell$. For $n$ an integer, we will construct morphisms $\psi_A: Y_0(\ell^n) \to \ag$. For each such map, the image of a point $(E, \phi)$ will be an abelian variety isogenous to $E^g$. As $n$ and the choice of maps vary, we obtain a sequence of curves $X_i \subset \ag$. We will show that \textcolor{red}{Restate below as theorems.}

\begin{theorem}\label{thm:curves-dense}
  The Zariski closure of ${\cup X_i}$ is $\ag$
\end{theorem}

\begin{theorem}\label{thm:Sg-dense}
  for all $i,j$, the Zariski closure of $\sg \cap (X_i \times X_j)$ is $X_i \times X_j$.
\end{theorem}
\begin{enumerate}
    \item\label{i:curves-dense} The Zariski closure of ${\cup X_i}$ is $\ag$ and
    \item\label{i:Sg-dense} for all $i,j$, the Zariski closure of $\sg \cap (X_i \times X_j)$ is $X_i \times X_j$.
\end{enumerate}
From these two properties, Theorem~\ref{thm:sg-c-dense} will follow. To obtain Theorem~\ref{thm:invariant-c-constant}, construct the fiber product
\[
  \xymatrix{
    \df \ar[r] \ar[d] & \ag \ar[d]^f \\
    \ag \ar[r]^f & X.
  }
\]
There is a natural map $\df \to \ag \times \ag$. The hypotheses on $f$ will imply that, viewed as functors, the latter map factors through $\sg$. Since the functor $\sg$ is ``dense'' in the sense of Theorem~\ref{thm:sg-c-dense}, we will have $\df = \ag \times \ag$, whence the claim follows.


\section{Constructing curves on $\ag$}
\label{sec:curves-on-Ag}

Fix a prime $\ell$ and positive integer $n$\textcolor{red}{TODO: what constraints are required for $n$?}. In this section we will construct a sequence of maps $X_0(\ell^n) \to \ag$ whose images $X_i$ are curves in $\ag$. These curves will be used in the steps outlined in Section~\ref{sec:introduction}.

We will describe the maps $X_0(\ell^n) \to \ag$ in two ways: one based on the moduli interpretation, and one based on complex analysis. The fact that these two interpretations are the same is key to the proof of Theorem~\ref{thm:sg-c-dense}. We will apply the moduli interpretation to prove step~\ref{i:Sg-dense}, and the complex analytic version to prove step~\ref{i:curves-dense}. \textcolor{red}{TODO: explain that the latter does not carry to characteristic $p$}

\subsection{Geometric description}
\label{sec:geo-desc}

Fix a positive integer $N$ not divisible by the characteristic of our base field; later we will set $N = \ell^n$. Let $(E, C) \in X_0(N)$. That is, $E$ is an elliptic curve and $C \subset E$ is a cyclic subgroup of order $N$. Let $A$ be a $g \times g$ symmetric, positive definite integer matrix such that $N \mid \det A$; say $\det A = M$. The matrix $A$ induces a natural endomorphism $\rho_A$ of $E^g$. Our choice of $A$ implies that $\rho_A$ corresponds to a polarization $\lambda_A$ \textcolor{red}{Clarify that polarization is an isogeny} of degree $M^2$---namely, it is $\lambda_{\Pi}\rho_A$, where $\lambda_\Pi$ is the principal product polarization. Let $K(A) \subset E^g$ be $\ker \lambda_A \cap C^g$.

\begin{lemma}
  $K(A)$ is a maximal isotropic subgroup of $\ker \lambda_A$.
\end{lemma}

\begin{proof}
  Let $P \in C$ be a generator, defined over the algebraic closure of our base field. We may identify $C^g$ with $(\Z/N)^g$ via the map $(a_iP) \mapsto (a_i)$. Then $\lambda_A$ induces a map $\lambda_A^{(C)}:C^g \to C^g$ which is given by multiplication by the matrix $A$. One sees that the order of $\ker \lambda_A^{(C)}$ is the square root of the order of $\ker \lambda_A$, and furthermore $\ker \lambda_A^{(C)} \subset C^g$ is isotropic. The claim follows.
\end{proof}

Define $B = E^g/K(A)$, and let $\pi: E^g \to B$ be the quotient map. Then by [Milne, AV, Prop. 16.8], there is a principal polarization $\lambda$ on $B$ for which $\pi^*(\lambda) = \lambda_A$. Since $\pi^*: NS(B) \to NS(A)$ is injective, $\lambda$ is unique.

We define $\psimod: X_0(N) \to \ag$ by
\[
  \psimod(E,C) = (B,\lambda).
\]

\begin{proposition}
  Let $d_1, \cdots, d_g$ be the elementary divisors of $A$, and for $(E,C) \in X_0(N)$, let $E_i = E/(N/d_i)C$. If $\psimod(E,C) = (B,\lambda)$, then
  \[
    B \approx E_1 \times \cdots \times E_g.
  \]
\end{proposition}

\begin{proof}
  Let
   \[
     D =
    \begin{bmatrix}
      {d_1} & & & \\
      & {d_2} & & \\
      & & \ddots & \\
      & & & {d_{g}}
    \end{bmatrix}
  \]
  be the Smith normal form of $A$. Then there are matrices $U,V \in \Gl_g(\Z)$ such that $A = UDV$. Each of these matrices induces a natural endomorphism of $E^g$; we use $\rho_M$ to denote the endomorphism corresponding to the matrix $M$. We have $\rho_A = \rho_U \rho_D \rho_V$, and $\rho_U, \rho_V$ are isomorphisms. We also have that
  \begin{align*}
    \ker \rho_D &= E[d_1] \times E[d_2] \times \cdots \times E[d_g]
  \end{align*}
  and so $(\ker \rho_D) \cap H = (N/d_1)C \times \cdots \times (N/d_g)C$. Furthermore, $\rho_V(H) = H$, and so
  \[
    \rho_V((\ker \rho_A) \cap H) = (\ker \rho_D) \cap H.
  \]
  Therefore the quotients of $E^g$ by $(\ker \rho_A) \cap H$ and $(\ker \rho_D) \cap H$ respectively are (weakly) isomorphic. The claim follows.
\end{proof}

\subsection{Analytic description}
\label{sec:ana-desc}

Suppose that $A \in M_{g \times g}$ is symmetric, positive definite, and has non-zero determinant $\det A = N$. Then there is map $\psi_A: \hh \to \hh_g$ given by
\[
  \psi_A(\tau) = \tau A.
\]
This descends to a map
\begin{equation}\label{def:psi-A-n}
  \hh/\Gamma_0(N) \to \hh_g/\Sp_{2g}(\Z).
\end{equation}
which gives a map $X_0(N) \to \ag$, which we also denote by $\psi_{A}$.

To see this, let $\sigma = \begin{bmatrix} a & b \\ c & d \end{bmatrix} \in \Gamma_0(N)$ and let $\tau \in \hh$. A direct computation shows that the matrix $M = \begin{bmatrix} aI & bA \\ cA^{-1} & dI \end{bmatrix}$ lies in $\Sp_{2g}(\Z)$
% it is integral because \det(A) | c, so cA^{-1} is integral.
% M is in Sp because then M^t*\Omega*M = M
% where \Omega = \begin{matrix} 0 & I \\ -I & 0 \end{matrix}
and that $\sigma(\tau)A = M(\tau A)$.

\textcolor{red}{TODO: is it ok to remove the $n$ subscript we had before?}

\textcolor{red}{TODO: is the following lemma necessary at all?}
The following shows that the image of $\psi_A$ in $\ag$ is weakly isomorphic to $\psi_{UAV}$ for any $U,V \in \Gl_g(\Z)$.

\begin{lemma}\label{lem:A-UAV-weakly-isom}
  Let $A$ be as above. If $U,V \in \Gl_g(\Z)$, then $\psi_{A}(\tau)$ is weakly isomorphic to $\psi_{UAV}(\tau)$ for all $\tau \in \hh$.
\end{lemma}
\begin{proof}
  We need to show that the lattices spanned by the columns of $\begin{bmatrix} I & A\tau \end{bmatrix}$ and $\begin{bmatrix} I & UAV\tau \end{bmatrix}$ are isomorphic. Note that the column span of $\begin{bmatrix} I & A\tau \end{bmatrix}$ is the same as that of the product
  \[
    \begin{bmatrix} U^{-1} & A\tau \end{bmatrix}\begin{bmatrix} I & 0 \\ 0 & V \end{bmatrix}
    =
    \begin{bmatrix} U^{-1} & AV\tau \end{bmatrix}.
  \]
  Multiplication on the left by $U$ gives an isomorphism between this lattice and $\begin{bmatrix} I & UAV\tau \end{bmatrix}$.
\end{proof}



\subsection{Equivalence of descriptions}

Write $\Omega$ for $\tau I$, where $I$ is the $g \times g$ identity matrix. The period matrix for $\psi_{I,n}(\tau)$ is
\[
  M = \begin{bmatrix}
    I | \Omega
  \end{bmatrix}.
\]
Observe that if $E$ is the elliptic curve corresponding to $\tau \in \hh$, then the abelian variety corresponding to $\psi_{I,n}(\tau) \in \hh_g$ is $E^g$ with the product polarization.

Given a period matrix $M$, let $\Lambda(M)$ be the lattice generated by the columns of $M$, so that the corresponding abelian variety is $A(M) := \C^g/\Lambda(M)$. We say two period matrices $M, M'$ are \emph{equivalent} if $\C^g/\Lambda(M)$ is isomorphic to $\C^g/\Lambda(M')$, and similarly the matrices are \emph{weakly equivalent} if the abelian varieties are weakly isomorphic. Let $D$ be the Smith normal form of $A$, so that there are $U,V \in \Gl_g(\Z)$ for which $A = UDV$. Then the period matrix for $\Psi_{A,n}(\tau)$ is
\[
  \begin{bmatrix}
    I | \Omega A
  \end{bmatrix},
\]
which is equivalent to
\[
  \begin{bmatrix}
    D^{-1}U^{-1} | V
  \end{bmatrix}
\]
and hence weakly equivalent to
\[
M' = \begin{bmatrix}
    D^{-1}U^{-1} | \Omega
  \end{bmatrix}.
\]
Let $M''$ be the period matrix\[
  \begin{bmatrix}
    D^{-1} | \Omega
  \end{bmatrix}.
\]
The matrix $D^{-1}$ is a diagonal matrix whose diagonal entries are powers of $1/\ell$. Suppose the $i$th diagonal entry is $1/\ell^{n_i}$, and set
\[
  \vec{n} = (n_1, \ldots, n_g).
\]
One sees that $A(M'') = \psivec(\tau)$, where $\lambda$ is the product polarization. In particular, if $P \in E$ generates the distinguished $\ell^n$-torsion subgroup, then
\[
  A(M'') = E/\langle \ell^{n-n_1} P \rangle \times \cdots \times E/\langle \ell^{n-n_g} P \rangle.
\]
The abelian variety $A(M')$ is similary a quotient of $E^g$ by an $\ell$-power subgroup. But the natural map $U: E^g \to E^g$ sends one kernel subgroup to another, and thus induces a (weak) isomorphism $A(M') \to A(M'')$. As $A(M'') = \psivec(\tau)$ and $A(M')$ is weakly isomorphic to $A(M) = \psimat(\tau)$, we conclude that
\[
\psimat(\tau) \textrm{ and } \psivec(\tau)
\]
are weakly isomorphic.

\newpage

\section{Step 1}
\label{sec:step-1}

In this section, we focus on Step~\ref{i:curves-dense} outlined in Section~\ref{sec:introduction}. That is, we aim to prove that
\[
  \bigcup_{A} \im\left(\psi_{A,n}\right) \text{ is Zariski dense in } \ag,
\]
where $A$ ranges over all symmetric positive definite integer matrices whose determinant is a power of $\ell$. Recall that $\ell$ is fixed.\textcolor{red}{TODO: reference where fixing of $\ell$ occurs}

We will actually show the slightly stronger claim that $\cup_{A} \psi_{A,n}(i\R)$ is holomorphically dense, where $A$ ranges over ???. That is, if any holomorphic function $f$ on $\ag$ vanishes on $\cup_{A} \psi_{A,n}(i\R)$, then $f$ vanishes everywhere.

For a ring $R$, let $\Sympd_g(R)$ denote the set of symmetric positive definite matrices in $\Sl_g(R)$. Recall that for any $A \in \Sympd_g(\Z[1/\ell])$, the map $\psi_{A,n}$ is induced from the map $\psi_A: \hh \to \hh_g$ given by $\tau \mapsto \tau A$. Therefore
\[
  \bigcup_{A \in \Sympd_g(\Z[1/\ell])} \psi_A(i\R) = i\R\Sympd_g\left(\Z\left[\frac{1}{\ell}\right]\right).
\]

\begin{lemma}
  $\Sympd_g\left(\Z\left[\frac{1}{\ell}\right]\right)$ is holomorphically dense in $\Sympd_g(\R)$.
\end{lemma}
\begin{proof}
  \textcolor{red}{TODO}
\end{proof}

\begin{lemma}
  $i\R\Sympd_g(\R)$ is holomorphically dense in $\hh_g$.
\end{lemma}
\begin{proof}
  \textcolor{red}{TODO}
\end{proof}

It follows that the image of the $\psi_{A,n}$ is dense in $\ag$.\textcolor{red}{TODO: check this and make it a cor. or something}

\section{Step 2}
\label{sec:step-2}

In this section, we focus on Step~\ref{i:Sg-dense} outlined in Section~\ref{sec:introduction}. That is, we aim to prove that
\[
  \zclos{\sg \cap (X_i \times X_j)} = X_i \times X_j.
\]
Here $X_i$ and $X_j$ are images of two maps of the form $\psi_{\vec{n},\lambda}$ from Section~\ref{sec:geo-desc} (see Equation~\ref{def:psi-A-n}).

We will prove the claim using the following lemma.

\begin{lemma}\label{lem:lim-degree}
  Let $\psi = \psi_{\vec{n},\lambda}$ and $\psi' = \psi_{\vec{n}',\lambda'}$ be two of the maps $X_0(\ell^n) \to \ag$ defined as in Equation~\ref{def:psi-A-n}. Then there exists a sequence $x_i \in X_0(\ell^n)$ such that
  \[
    \lim_{i \to \infty}\#\left\{ y \in X_0(\ell^n) \colon \text{ $\psi(x_i)$ and $\psi'(y)$ are weakly isomorphic} \right\} = \infty.
  \]
\end{lemma}

Before we prove Lemma~\ref{lem:lim-degree}, we will show how to finish the argument.

\begin{corollary}
  Let $\psi$ and $\psi'$ be as in Lemma~\ref{lem:lim-degree}, and let $X$ and $X'$ be their images in $\ag$. Then
  \[
    \zclos{\sg \cap (X \times X')} = X \times X'.
  \]
\end{corollary}
\begin{proof}
  By Lemma~\ref{lem:lim-degree}, $\sg \cap (X \times X')$ has an infinite number of geometric points. This implies that $\dim \zclos{\sg \cap (X \times X')} \geq 1$. Suppose the dimension equals $1$, so that $\zclos{\sg \cap (X \times X')}$ is a finite union of curves $V = \cup V_i$. The $V_i$ cannot all be horizontal components---that is, of the form $X \times \{z\}$---since this would contradict Lemma~\ref{lem:lim-degree}. Let $V'$ be $V$ with the horizontal components removed. Consider the projection $\pi_X: V' \to X$. Lemma~\ref{lem:lim-degree} implies that this map has unbounded degree. But $\pi_X$ on each irreducible component of $V'$ is nonconstant, and so $\pi_X|_{V'}$ has finite degree, yielding a contradiction. Therefore $\dim \zclos{\sg \cap (X \times X')} \geq 2$, whence the claim follows.
\end{proof}

We now return to the proof of Lemma~\ref{lem:lim-degree}.

\begin{proof}[Proof of Lemma~\ref{lem:lim-degree}]
  Choose a quadratic imaginary field $K$, principal prime $\varphi\sO_K$ over $\ell$, and rational primes $c_i$ as in Lemma~\ref{lem:K-exists} below. Let $E$ be an elliptic curve over an algebraically closed field with CM by $\sO_K$.

  Let $\sC$ denote a cyclic subgroup of $E$ with order prime to $\ell$. Then the set of subgroups $\sC_i, \varphi(\sC), \dots, \varphi^n(\sC)$ give a set of $\ell$-isogenies from $E$. Note that $\varphi$ induces a map $E/\varphi^j(\sC) \to E/\varphi^{j+1}(\sC)$. Thus we have the following diagram
  \[
    \begin{tikzcd}
      \sC \arrow[d,"\varphi"] \arrow[r] & E \arrow[d,"\varphi"] \arrow[r] & E/\sC \arrow[d]
      \\
      \varphi(\sC) \arrow[d,"\varphi"] \arrow[r] & E \arrow[d,"\varphi"] \arrow[r] & E/\varphi(\sC) \arrow[d]
      \\
      \vdots \arrow[d,"\varphi"] & \vdots \arrow[d,"\varphi"] & \vdots \arrow[d]
      \\
      \varphi^n(\sC) \arrow[r] & E \arrow[r] & E/\varphi^{n}(\sC).
    \end{tikzcd}
  \]
  Let $\varphi^{\ast}_\sC$ denote the composition $E/\sC \to \cdots \to E/\varphi^n(\sC)$. This is an $\ell^n$-isogeny, so the pair $(E/\sC,\varphi^{\ast}_\sC)$ defines a point in $X_0(\ell^n)$.

  For each $i$, we fix a cyclic subgroup $\sC_i$ of $E$ with order $c_i$. Define $x_1$ to be $(E/\sC_1,\varphi^{\ast}_{\sC_1})$. Before defining $x_2,x_3,\dots$, we will first describe a set of $y$ such that $\psi(x_1) = \psi'(y)$.

  Recall from Section~\ref{sec:geo-desc} the description of $\psi = \psi_{\vec{n},\lambda}$. Because we have the decomposition of $\varphi^{\ast}_{\sC_1}$ into a sequence of $\ell$-isogenies, we have
  \[
    \psi(E/\sC_1,\varphi^{\ast}_{\sC_1}) = (E/\varphi^{n_1}(\sC_1) \times \cdots \times E/\varphi^{n_g}(\sC_1),\lambda).
  \]
  The set of $c_1$-torsion subgroups of $E$ is a $(\sO_K/c_1\sO_K)^\times/(\Z/c_1\Z)^\times \cong \F_{c_1^2}^\times/\F_{c_1}^\times$ torser by Lemma~\ref{lem:c-torsor}. Recall from our construction of the $c_i$ that $\varphi \mod{c_i\sO_K}$ is a $g$th power. So we can find some $\gamma \in \F_{c_1^2}^\times$ such that $\varphi \equiv \gamma^g \mod{c_1\sO_K}$. In particular, $\varphi(\sC_1) = \gamma^g(\sC_1)$.

  The set of $y$ we will construct will be of the form $\psi'(E/\beta\sC_1,\varphi^{\ast}_{\beta\sC_1}))$ for some $\beta \in \F_{c_1^2}^\times/\F_{c_1}^\times$. We need to ensure that $\psi(x_i) \cong \psi'(y)$ as unpolarized abelian varieties. This means that we need to find $\beta$ such that
  \[
    E/(\gamma^g)^{n_1}(\sC_1) \times \cdots \times E/(\gamma^g)^{n_g}(\sC_1)
    \cong
    E/(\gamma^g)^{n_1'}(\beta\sC_1) \times \cdots \times E/(\gamma^g)^{n_g'}(\beta\sC_1).
  \]
  By Lemma~\ref{lem:prod-equiv-torsor}, this holds if and only if
  \[
    (\gamma^{n_1 + \cdots + n_g})^g = \beta^g(\gamma^{n_1' + \cdots n_g'})^g.
  \]
  The hypothesis on the $c_i$ implies that $g$ divides $\#(\F_{c_i^2}^\times/\F_{c_i}^\times) = c_i + 1$, so there are $g$ distinct solutions $\beta \in \F_{c_i^2}^\times/\F_{c_i}^\times$ to this equation.\footnote{Note that these solutions are not the solutions in $\F_{c_i^2}$ reduced mod $\F_{c_i}$. For example, $\beta^4 = 1$ has $4$ solutions in $\F_9$, but modulo $\F_3^\times$ these give only $2$ distinct solutions. On the other hand, $\beta^4 = 1$ has $4$ distinct solutions in $\F_9/\F_3$, namely $1+i$ and $(1+i)^3$, because $1+i$ is a generator for $\F_9^\times$ as a cyclic group.} This gives us $g$ points $y \in X_0(\ell^n)$ with $\psi(x_1) = \psi'(y)$.

  For $x_2$, we repeat much of the same construction except that instead of using $\sC_2$, we use $\sC_1\sC_2$ and liberally apply the Chinese remainder theorem. The set of subgroups of $E$ with order $c_1c_2$ is a torser over $(\F_{c_1^2}^\times/\F_{c_1}^\times) \times (\F_{c_2^2}^\times/\F_{c_2}^\times)$. Then we are searching for $\beta \in \sO_K/c_1c_2\sO_K$ such that
  \[
    E/\varphi^{n_1}(\sC_1\sC_2) \times \cdots \times E/\varphi^{n_g}(\sC_1\sC_2)
    \cong
    E/\varphi^{n_1'}(\beta(\sC_1\sC_2)) \times \cdots \times E/\varphi^{n_g'}(\beta(\sC_1\sC_2)).
  \]
  Again this reduces to counting the number of solutions $\beta$ to an equation of the form $(\gamma^{g})^{n_1 + \cdots + n_g} = \beta^g(\gamma^g)^{n_1' + \cdots n_g'}$, except that this equation is modulo $c_1c_2\sO_K$. By a similar argument, we can find $g^2$ points $y \in X_0(\ell^n)$ such that $\psi(x_2) = \psi'(y)$.

  Continuing in the same fashion shows that for each $x_i$, there are $g^i$ points $y \in X_0(\ell_n)$ such that $\psi(x_i) = \psi'(y)$.
\end{proof}

\begin{lemma}\label{lem:c-torsor}
  Let $E$ be an ordinary elliptic curve over an algebraically closed field with CM by $\sO_K$ for some imaginary quadratic field $K$ with $\sO_K^\times = \{\pm 1\}$. Let $c$ be a prime not equal to the characteristic of the base field and inert in $K$. Then the set of $c$-torsion subgroups of $E$ form a $(\sO_K/c\sO_K)^\times/(\Z/c\Z)^\times$ torsor.
\end{lemma}
\begin{proof}
  To prove the claim, we will show that $E[c] \cong \sO_K/c\sO_K$ as an $\sO_K$-module. Note that if the base field is $\C$, then $E \cong \C/I$ for some ideal $I$ of $\sO_K$. Since $\C/I \cong \C/J$ for any $J$ in the same ideal class as $I$, we may assume $I$ is coprime to $c$. Then $E[c] \cong \frac{1}{c}I/I \cong I/cI \cong \sO_K/c\sO_K$ as $\sO_K$ modules. If the base field is $\overline{\F}_p$, then we can find a model of $E$ over a finite field $\F_q$ with $E[c] \subseteq E(\F_q)$. By \cite[Thm.~1]{complex1996lenstra}, $E(\F_q) \cong \End_{\F_q}(E) / (\pi - 1)$ as $\End_{\F_q}(E)$ modules. Here $\pi$ is the $q$th power Frobenius. As $E$ is ordinary, $\End_{\F_q}(E) \cong \sO_K$. Moreover, $E[c] \subseteq E(\F_q)$ implies that $c \mid \Nm(\pi - 1) \Rightarrow c\sO_K \supseteq (\pi - 1)$. Hence $E[c] \cong (\sO_K/(\pi - 1))/(c\sO_K/(\pi - 1)) \cong \sO_K/((c) + (\pi - 1)) \cong \sO_K/c\sO_K$.
\end{proof}

\begin{lemma}\label{lem:prod-equiv-torsor}
  Let $E,K,c$ be as in Lemma~\ref{lem:c-torsor}. Let $\sC$ be a $c$-torsion subgroup of $E$. If $\alpha_1,\dots,\alpha_n,\beta_1,\dots,\beta_n \in \sO_K$ are prime to $c$, then
  \[
    \prod_{i=1}^n E/\alpha_i(\sC) \approx \prod_{i=1}^n E/\beta_i(\sC)
    \quad\Leftrightarrow\quad
    \prod_{i=1}^n \alpha_i \equiv \prod_{i=1}^n \beta_i,
  \]
  where the second equivalence is as elements of $(\sO_K/c\sO_K)^\times/(\Z/c\Z)^\times$.
\end{lemma}
\begin{proof}
  First we will reduce to the case where $\alpha_i = \beta_i = 1$ for $i < n$. Consider the $n \times n$ diagonal matrix $M$ with entries $\alpha_1^{-1},\alpha_2^{-1},\dots,\alpha_{n-1}^{-1}, (\alpha_1 \cdots \alpha_{n-1})$. Note that $M\mod{c\sO_K} \in \Sl_n(\sO_K/c\sO_K)$. By \cite[Cor.~5.2, Pg.~18]{ktheory1964bass}, we can find $M' \in \Sl_n(\sO_K)$ such that $M \equiv M' \mod{c\sO_K}$. The matrix $M'$ corresponds to an automorphism of $E^n$ sending $\prod \alpha_i(\sC)$ to $\sC^{n-1} \times \left(\prod \alpha_i\right)(\sC)$. This shows that
  \[
    \prod E/\alpha_i(\sC) \cong \prod E/\beta_i(\sC)
    \quad\Leftrightarrow\quad
    \left(E/\sC\right)^{n-1} \times E/\alpha(\sC) \cong \left(E/\sC\right)^{n-1} \times E/\beta(\sC)
  \]
  where $\alpha = \prod\alpha_i$ and $\beta = \prod \beta_i$. Next we will apply the results from \cite{kani2011products} to ``cancel out'' the $E/\sC$ on both sides of the isomorphism on the right.

  Note that $\alpha$ induces an isogeny $\tilde{\alpha}: E/\sC \to E/\alpha(\sC)$. % We claim that $\sC$ is not an ideal subgroup\footnote{See \cite[Sec.~2, Pg.~302]{kani2011products} for the definition of ideal subgroup and kernel ideal.}.
  Let $\sO$ be an order in $K$ isomorphic to $\End E/\sC$. Recall that since $E \to E/\sC$ is an isogeny of prime degree $c$, we have that $[\sO_K : \sO] \mid c$ \cite[Prop.~5]{kohel1996endomorphism}. Because $c$ is inert in $K$, $\sO_K$ has no ideals of norm $c$. So by \cite[Thm.~20b]{kani2011products}, $\sC$ is not an ideal subgroup of $E$ and $\End E/\sC \not\cong \End E$. Hence $[\sO_K : \sO] = c$. This argument holds for any $c$-torsion subgroup, so it shows that $\End E/\sC \cong \End E/\alpha(\sC) \cong \sO$. Thus by \cite[Thm.~20b]{kani2011products}, $\ker\tilde{\alpha}$ is an ideal subgroup. The same holds for $\beta$ as well.

  For any isogeny $\phi$ with domain $E/\sC$, let $I(\phi)$ denote the kernel ideal of the subgroup $\ker\phi$.
  %I(\phi) = \{f \in \End E/\sC \colon \ker f \supseteq \ker \phi \}
  By \cite[Thm.~46]{kani2011products},
  \begin{align*}
    \left(E/\sC\right)^{n-1} \times E/\alpha(\sC) \approx \left(E/\sC\right)^{n-1} \times E/\beta(\sC)
    \\
    \Leftrightarrow
    \left(\bigoplus_{i=1}^{n-1} I(id)\right) \oplus I(\tilde{\alpha}) \cong \left(\bigoplus_{i=1}^{n-1} I(id)\right) \oplus I(\tilde{\beta}).
  \end{align*}
  where $id$ is the identity map on $E/\sC$ and the second isomorphism is as $\sO$-modules. By \cite[Thm.~48]{kani2011products}, the latter isomorphism is equivalent to
  \[
    I(id)^{n-1}I(\tilde{\alpha}) \cong I(id)^{n-1}I(\tilde{\beta}).
  \]
  But $I(id) = \End E/\sC$, so this is equivalent to $I(\tilde{\alpha}) \cong I(\tilde{\beta})$. Applying \cite[Thm.~46]{kani2011products} to these two ideals shows that
  \[
    I(\tilde{\alpha}) \cong I(\tilde{\beta})
    \quad\Leftrightarrow\quad
    E/\alpha(\sC) \cong E/\beta(\sC).
  \]
  Because $\sO_K^\times \cong \Aut E = \{\pm 1\}$, the last isomorphism holds if and only if $\alpha(\sC) = \beta(\sC)$. The conclusion then follows by Lemma~\ref{lem:c-torsor}.
\end{proof}

\begin{lemma}\label{lem:silly}
  Let $\ell$ be a prime. Then there is a quadratic imaginary field $K$ such that $\ell$ splits into principal primes in $K$ and $\sO_K^\times = \{\pm 1\}$.
\end{lemma}
\begin{proof}
  The possible fields $K$ in which $\ell$ splits into principal primes are precisely the fields generated by the polynomials $x^2 - tx + \ell$ with $0 < |t| < 2\sqrt{\ell}$. There are $2\lfloor 2\sqrt{\ell} \rfloor$ such polynomials. Recall that there are, up to Galois conjugates, $\leq 4$ elements of norm $\ell$ in $\Q(i)$ and $\leq 6$ in $\Q(\sqrt{-3})$. Therefore, if $4\sqrt{\ell} > 10$ then there are more than $10$ such polynomials, so one must correspond to a field other than $\Q(i)$ and $\Q(\sqrt{-3})$. The the remaining primes $\ell < 7$ can be checked by hand.
\end{proof}

\begin{lemma}\label{lem:K-exists}
  Let $g$ be a positive integer and $\ell$ a prime. Then there exists a quadratic imaginary field $K$ such that
  \begin{enumerate}
    \item $\sO_K^\times = \{\pm 1\}$
    \item $\ell$ splits in $K$ into principal primes $\alpha\sO_K \cdot \overline{\alpha}\sO_K$
    \item There is an infinite number of rational primes $c$ such that
    \begin{enumerate}
      \item $c$ is inert in $K$
      \item $c \equiv -1 \mod{g}$
      \item $\alpha \mod c\sO_K \in \sO_K/c\sO_K$ is a $g$th power.
    \end{enumerate}
  \end{enumerate}
\end{lemma}
\begin{proof}
  By Lemma~\ref{lem:silly}, we can find a $K$ satisfying the first two properties. Let $L = K(\zeta_g,\alpha^{1/g},\overline{\alpha}^{1/g})$.
  %The fields can be visualized in the following tower.
  %\[
  %\begin{tikzcd}
  %  &
  %  L
  %  \arrow[d,-]
  %  \\
  %  &
  %  K(\zeta_g)
  %  \arrow[dl,-] \arrow[dr,-]
  %  \\
  %  \Q(\zeta_g)
  %  \arrow[dr,-]
  %  &&
  %  K
  %  \arrow[dl,-]
  %  \\
  %  &
  %  \Q
  %\end{tikzcd}
  %\]
  Let $\frak{c}$ be a prime of $L$ lying over a prime $c$ of $\Q$. Let $\sigma = \mathrm{Frob}(\frak{c}) \in \Gal(L/\Q)$. Note that $c$ is inert in $K$ if and only if $\sigma|_K$ is complex conjugation. Similarly, $c \equiv -1 \mod{g}$ if and only if $\sigma|_{\Q(\zeta_g)}$ is complex conjugation.
%To see this, note that under the usual isomorphism $\Gal(\Q(\zeta_g)/\Q) \cong (\Z/g\Z)^\times$, complex conjugation is associated to $-1$. The map Frobenius element corresponding to $\frak{c} \cap \Q(\zeta_g)$ sends $\zeta_g \mapsto \zeta_g^c$.
Finally, if $\sigma$ has order $2$, then $\sO_L/\frak{c} \cong \sO_K/c\sO_K \cong \F_{c^2}$. In particular, $\alpha^{1/g}$ is a $g$th root of $\alpha$ in $\F_{c^2}$. Moreover, if $\sigma$ satisfies these conditions, then so does any conjugate of $\sigma$. So by Chebotarev's density theorem, it remains to show there exists some $\sigma \in \Gal(L/\Q)$ such that $\sigma$ has order $2$ and restricts to complex multiplication in $K$ and $\Q(\zeta_g)$.

  Choose any embedding $\iota: L \to \C$ and define $\sigma \in \Gal(L/\Q)$ by $a \mapsto \iota^{-1}(\overline{\iota(a)})$. Note that $\sigma$ has order $2$. Because $K$ and $\Q(\zeta_g)$ are CM fields, $\sigma$ restricts to the usual complex conjugation on them. Therefore $\sigma$ has the desired properties.
\end{proof}

\section{Matrix density results}
\label{sec:matr-dens-results}

\begin{lemma}\label{lemma:sl-z-1overl-dense-sl-r}
  $\tclos{\Sl_g(\Z[1/\ell])} = \Sl_g(\R)$.
\end{lemma}

\begin{proof}
  Let $G \in \Sl_g(\R)$. Factor $G$ as a product of elementary matrices
  \[
    G = E_n \cdots E_2 E_1
  \]
  where $\det E_i = \pm 1$. Observe that, with at most one exception, the entries of each $E_i$ are $0$ or $\pm 1$. Thus we can find a $g \times g$ matrix $E_i'$ with entries in $\Z[1/\ell]$ and $\det E_i' = \det E_i$ which is arbitrarily close to $E_i$. Let $G' = E_n' \cdots E_1'$. Certainly $G' \in \Sl_g(\Z[1/\ell])$. Since matrix multiplication is continuous, $G'$ is close to $G$.
\end{proof}

% \begin{proof}[Alternative proof]
%   Let $G = [g_{ij}] \in \Sl_g(\R)$. Let $X = [x_{ij}]$ be a matrix of $g^2$ variables, and consider the determinant map $\det: \R[\{x_{ij}\}] \to \R$. Choose $r,s$ so that
%   \[
%     \frac{\partial \det}{\partial x_{rs}}(G) \neq 0.
%   \]
%   Since $\Z[1/\ell]$ is dense in $\R$, for $(i,j) \neq (r,s)$ we can find $a_{ij} \in \Z[1/\ell]$ which is arbitrarily close to $g_{ij}$. By our hypotheses on $(r,s)$, there exists $a_{rs} \in \R$ such that $\det [a_{ij}] = 1$. Clearly $a_{rs} \in \Z[1/\ell]$. The determinant is continuous, so $a_{rs}$ must also be close to $g_{rs}$.
% \end{proof}

% \begin{proof}
%   The group scheme $\Sl_g$ is a connected reductive group, and hence is unirational. (???cite) Since $\Z[1/\ell]$ is topologically dense in $\R$, the claim follows.

%   Details: unirational means there is a dominant rational map $f:\Pro^n \to \Sl_g$ for some $n$. Given $G \in \Sl_g(\R)$, there some $G' \in f(\Pro^n(\R))$ which is close to $G$. Let $P \in \Pro^n(\R)$ with $f(P) = G'$. Then
% \end{proof}

\begin{definition}
  For $\ell$ a prime, let $\detl$ be the set of $g \times g$ symmetric, positive definite integer matrices $N$ for which $\det N$ is a power of $\ell$.
\end{definition}

\begin{lemma}\label{lemma:ggt-spd-detl}
  If $G \in \Sl_g(\Z[1/\ell])$, then for all sufficiently large $n \in \N$,
  \[
    \ell^n GG^t \in \detl.
  \]
\end{lemma}

\begin{proof}
  Certainly for all $n$, $\ell^n GG^t$ will be symmetric, positive definite, and have determinant which is an integer power of $\ell$. Choose $N$ to be the maximum power of $\ell$ appearing in the denominators of the entries of $GG^t$. Then for $n \geq N$, $\ell^n GG^t$ is an integer matrix.
\end{proof}


\begin{definition}
  Let $\permat$ be the set of $g \times g$ real, positive definite symmetric matrices  with determinant $1$.
\end{definition}

\begin{lemma}\label{lemma:ggt-periodmatrices}
  $\permat = \{GG^t | G \in \Sl_g(\R)\}$.
\end{lemma}

\begin{proof}
  Suppose $A \in \permat$. By the Spectral Theorem, there exist a real orthogonal matrix $O$ and a real diagonal matrix $D$ such that $A = ODO^t$. Let $D$ have diagonal entries $d_1, d_2, \dots, d_n$. Since $A$ is positive definite, $d_i > 0$ for all $i$. Furthermore, $\prod d_i = \det A = 1$. Let
  \[
    G = O
    \begin{bmatrix}
      \sqrt{d_1} & & & \\
      & \sqrt{d_2} & & \\
      & & \ddots & \\
      & & & \sqrt{d_{g}}
    \end{bmatrix}.
\]
Then $A = GG^t$ and $G \in \Sl_g(\R)$.
\end{proof}

\begin{proposition}\label{prop:A-over-detA}
  $\tclos{\{A/(\det A)^{\frac{1}{g}} | A \in \detl\}} = \permat$.
\end{proposition}

\begin{proof}
  In the set
  \[
    \{A/(\det A)^{\frac{1}{g}} | A \in \detl\},
  \]
  by Lemma~\ref{lemma:ggt-spd-detl}, we may replace $A$ with $\ell^n GG^t$ with $G \in \Sl_g(Z[1/\ell])$, $n$ sufficiently large (depending on $G$). But $\det (\ell^n GG^t) = \ell^n$, so the above set equals
  \[
    \{GG^t | G \in \Sl_g(\Z[1/\ell])\}.
  \]
  The claim follows from combining Lemmas~\ref{lemma:sl-z-1overl-dense-sl-r} and \ref{lemma:ggt-periodmatrices}.
\end{proof}

Let $\R^+$ denote the set of positive real numbers.
\begin{lemma}\label{lemma:holomorphic-closure-irM}
  $\hclos{\{ irM | M \in \permat, r \in \R^+\}} = \hh_g$.
\end{lemma}

\begin{proof}
  This is a standard result in multivariable complex analysis, which we are all completely familiar with.
\end{proof}

\begin{lemma}
  \[
    \hclos{\bigcup_{A \in \detl} \psi_A(i\R^+)} = \hh_g.
  \]
\end{lemma}

\begin{proof}
  Observe that if $X$ is a subset of a complex manifold, then $\tclos{X} \subset \hclos{X}$. Now
  \begin{align*}
    \cup \psi_A(i\R^+) &= \cup \{irA | r \in \R^+, A \in \detl\} \\
               &= \cup \{irA/(\det A)^{\frac{1}{g}} | r \in \R^+, A \in \det l\}.
  \end{align*}
  By Proposition~\ref{prop:A-over-detA}, the topological closure of the above set is
  \[
    \{irM | r \in \R^+, M \in \permat\}.
  \]
  The result now follows from Lemma~\ref{lemma:holomorphic-closure-irM}.
\end{proof}

\begin{lemma}
  \[
    \hclos{\bigcup_{A \in \detl} \im \psi_A} = \hh_g.
  \]
\end{lemma}

\begin{proof}
  Since $\psi_A(i\R^+) \subset \im \psi_A$, the claim follows from the previous lemma.
\end{proof}

\begin{proposition}
  \[
    \zclos{\bigcup_{A \in \detl} \im \psimat} = \ag.
  \]
\end{proposition}

\begin{proof}
  By definition of $\psimat$, the $\im \psimat \subset \ag$ is the image of $\im \psi_A \subset \hh_g$ under the canonical covering map $\hh_g \to \ag$. As we have shown, $\im \psi_A$ is holomorphically dense in $\hh_g$, and so its image in $\ag$ is holomorphically dense when viewing $\ag$ as a complex manifold. But holomorphically dense implies Zariski dense.
\end{proof}

\section{Characteristic $p$}
\label{sec:characteristic-p}

\begin{theorem}
  Let $\psivec: X_0(\ell^n) \to \ao^g$ be the map defined in Section~\ref{sec:geo-desc}. Then $\bigcup\im\psivec$ is dense in $\ao^g$.
\end{theorem}
\begin{proof}
  Let $E_0$ be an ordinary elliptic curve with CM by $\sO_K$ for some quadratic imaginary field $K$. Choose a prime $\ell$ inert in $K$ and fix an $\ell$-torsion subgroup $\sC_0$ of $E_0$. Let $\pi_0$ denote the quotient map $E_0 \to E_0/\sC_0 =: E_1$. Note that since $\sC_0$ is not a kernel ideal of $E_0$, we must have that $\End E_1 \cong \Z + \ell\sO_K$.

  We can continue this construction recursively. Let $\sC_i$ be any $\ell$-torsion subgroup of $E_i$ other than $\pi_{i-1}(\sC_{i-1})$. Then let $\pi_i$ be the quotient map $E_i \to E_i/\sC_i =: E_{i+1}$. Again, we have that $\End E_{i+1} \cong \Z + \ell^{i+1}\sO_{i}$ by \textcolor{red}{TODO: cite Kani?}.

  The composition $\pi^{(n)} = \pi_{n-1} \circ \cdots \circ \pi_0$ is a cyclic $\ell^n$-isogeny on $E$ because \textcolor{red}{TODO: there is no backtracking}.

  Note that the set $\{E_i\}$ is an infinite set of distinct elliptic curves, so it is dense in $\ao$. Therefore the product $\{E_i\} \times \cdots \times \{E_i\}$ is dense in $\ao^g$. It remains to show that this set lies in $\bigcup\im\psivec$.

  Let $E_{n_1},\dots,E_{n_g} \in E$. Choose $n > \max\{n_i\}$. Then let $A$ be the diagonal matrix with entries $\ell^{n_1},\dots,\ell^{n_g}$. Consider the point $(E_0,\pi^{(n)}) \in X_0(\ell^n)$. By construction,
  \[
    \psivec(E_0,\pi^{(n)}) \cong E_{n_1} \times \cdots \times E_{n_g}.
  \]
\end{proof}



%We will show $\cup \im \psivec$ is dense in $\ao^g$. Choose a sequence of elliptic curves $(E_i)$ over $\fpbar$ as follows. Fix an ordinary curve $E_0$ with a cyclic $\ell$-isogeny $E_0 \to E_1$ so that the endomorphism rings are different. Repeat with $E_i$\textcolor{red}{Travis: I think we want to avoid going back, so we could say the endomorphism ring is strictly smaller}. Then $\overline{\{E_i\}} = \ao$, and hence
%\[
%  \overline{\{E_{i_1} \times \cdots \times E_{i_g}\}} = \ao^g.
%\]
%Furthermore, each element in the left-hand set above is in the image of $\psivec$ for some $\vec{n}$.

\bibliographystyle{alpha}
\bibliography{./references}

\end{document}
