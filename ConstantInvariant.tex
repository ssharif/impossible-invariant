\documentclass{amsart}
\usepackage{amsmath, amsthm, amssymb,latexsym,enumerate,mathrsfs}
\usepackage[all]{xy}
\usepackage{enumitem}
\usepackage{hyperref}
\usepackage{invariant}
\usepackage{xcolor}
\usepackage{tikz-cd}
\usepackage{verbatim}
\usepackage{lineno}
\linenumbers

%\numberwithin{equation}{section}


\title[Algebraic maps constant on unpolarized isomorphism classes]{Algebraic maps constant on isomorphism classes of unpolarized abelian varieties are constant}

\author[E.\ Rains]{E.\ Rains}
\address{}
\email{}
\author[K.\ Rubin]{K.\ Rubin}
\address{}
\email{}
\author[T.\ Scholl]{T.\ Scholl}
\address{}
\email{}
\author[S.\ Sharif]{S.\ Sharif}
\address{}
\email{}
\author[A.\ Silverberg]{A.\ Silverberg}
\address{Department of Mathematics, University of California, Irvine, CA 92697, USA}
\email{asilverb@uci.edu}
%\subjclass[2010]{??}
\keywords{abelian varieties, polarizations}
\thanks{Support for the research was provided by the Alfred P.~Sloan Foundation
and the National Science Foundation.}

\begin{document}

\begin{abstract}
?
\end{abstract}


\today
\maketitle

%\tableofcontents


\section{Introduction}
\label{sec:introduction}

If $A_1$ and $A_2$ are abelian varieties, we say $A_1$ and $A_2$ are \emph{weakly isomorphic}, written $A_1 \approx A_2$, if $A_1$ and $A_2$ are isomorphic as unpolarized abelian varieties. Let $\ag$ denote the moduli space of principally polarized abelian varieties of dimension $g$. Our main result is the following.
\begin{theorem}\label{thm:invariant-c-constant}
  Suppose that $g\in\Z_{\ge 2}$, $R$ is a domain, and $f: \ag \to X$ is a morphism of $R$-schemes. Suppose $f(A_1) = f(A_2)$ whenever $A_1 \approx A_2$. Then $f$ is a constant function.
\end{theorem}

It suffices to prove Theorem \ref{thm:invariant-c-constant} when $R$ is an algebraically closed field, since a scheme over an algebraically closed field $k$ is also a scheme over every subring of $k$.


% Let $R$ be a scheme, and for an $R$-scheme $S$ write $S[R]$\textcolor{red}{TODO: is this necessary?} to be the set
% \[
%   \dlim_{T/R} S(T)
% \]
% where the limit is over all $R$-schemes $T$. Let
% \[
%   \sg: \rschemes \to \mathcal{P}((\ag \times \ag)[R])
% \]
% be the functor from $R$-schemes to the power set of $(\ag \times \ag)[R]$ that sends an $R$-scheme $T$ to the set
% \[
%   \sg(T) = \{(A,B) \in (\ag \times \ag)(T) | A \approx B\}.
% \]


If $R$ is a scheme, let
$$
\sg(R) = \{(A_1,A_2) \in (\ag \times \ag)(R) | A_1 \approx A_2\}.
$$
We will deduce Theorem \ref{thm:invariant-c-constant} from the following result.

\begin{theorem}\label{thm:sg-c-dense}
  If $g\in\Z_{\ge 2}$, $R$ is a domain, $k$ is an algebraically closed field, and $R \subseteq k$, then the set $\sg(k)$ is Zariski dense in the $R$-scheme $\ag \times \ag$.
\end{theorem}

%In arbitrary characteristic we have the following, which w
We will prove the following result in \S\ref{sec:characteristic-p}.
\begin{theorem}\label{thm:arbit-char}
  Suppose that $g\in\Z_{\ge 2}$, $R$ is a scheme, and $f: \ao^g \to X$ is a morphism of $R$-schemes. Suppose $f(A_1) = f(A_2)$ whenever $A_1 \approx A_2$. Then $f$ is a constant function.
\end{theorem}

Our motivation behind Theorem \ref{thm:arbit-char} is the proposal for a construction of a cryptographic protocol in~\cite{multiparty}. In that protocol, $n$ parties each construct a product of elliptic curves over a finite field such that any pair of products is isomorphic. Put another way, each party computes a point of $\ao^g$ so that the chosen points are weakly isomorphic to each other. However, the proposal for a protocol was incomplete. The open question in~\cite{multiparty} was whether one can extract a numerical invariant of the product of elliptic curves that respects weak isomorphism, that is, a non-constant map $f: \ao^g \to X$ for a suitable space $X$ such that $f(A_1) = f(A_2)$ whenever $A_1 \approx A_2$. In this context, Theorem~\ref{thm:arbit-char} shows that if $f$ is algebraic, then it is constant, and thus not useful cryptographically. It remains an open problem whether there is a useful non-algebraic invariant of (isomorphism classes of non-polarized) products of elliptic curves.


If $N$ is a positive integer, let $Y_0(N)$ denote the modular curve parametrizing pairs $(E, C)$, where $E$ is an elliptic curve and $C \subset E$ is a cyclic subgroup of $E$ of order $N$. If $A$ is a positive definite, symmetric, integer $g\times g$ matrix, define a map $\psimod: Y_0(\det(A)) \to \ag$ as follows. Suppose $(E, C) \in Y_0(\det(A))$. The matrix $A$ induces a natural endomorphism $\lambda_A$ of $E^g$. Since $A$ is symmetric and positive definite, we can view $\lambda_A$ as a polarization on $E^g$. Let $B = E^g/((\ker \lambda_A) \cap C^g)$ and let $\pi: E^g \to B$ be the quotient map. Then by~\cite[Prop. 16.8]{milne-av} there is a uniqe principal polarization $\lambda$ on $B$ such that $\pi^*(\lambda) = \lambda_A$. Define
\begin{equation}\label{def:psimoddef}
\psimod: Y_0(\det(A)) \to \ag  \text{ by } \psimod(E,C) = (B,\lambda).
\end{equation}
%by sending $(E,C) \in Y_0(N)$ to the abelian variety $B$ with principal polarization $\lambda$, and l
Let
\begin{equation}\label{def:XAdef}
X_A=\psimod(Y_0(\det(A))).
\end{equation}
(For another construction of the maps $\psimod$, see \cite[p. 19 et seq.]{rains}.)

\begin{definition}\label{def:detl}
If $\ell$ is a prime number and $g$ is a positive integer, let $\detl$ denote the set of positive definite symmetric $g \times g$ integer matrices whose determinant is a power of $\ell$.
\end{definition}

\begin{theorem}\label{thm:Sg-dense}
  Suppose $\ell$ is a prime number, $g\in\Z_{\ge 2}$, and $k$ is an algebraically closed field. Suppose $A,A' \in \detl$. Then $\sg(k) \cap (X_A \times X_{A'})(k)$ is Zariski dense in $X_A \times X_{A'}$.
\end{theorem}

\begin{theorem}\label{thm:curves-dense}
    Suppose $\ell$ is a prime number and $g\in\Z_{\ge 1}$. Then $\bigcup_{A \in \detl} X_A$ is Zariski dense in $\ag$.
\end{theorem}

Theorems \ref{thm:Sg-dense} and \ref{thm:curves-dense} are proved in \S\ref{sec:step-2} and \S\ref{sec:step-1}, respectively. Next, we derive Theorem \ref{thm:sg-c-dense} from Theorems \ref{thm:Sg-dense} and \ref{thm:curves-dense}, and we derive Theorem \ref{thm:invariant-c-constant} from Theorem \ref{thm:sg-c-dense}.

\begin{proof}[Proof of Theorem~\ref{thm:sg-c-dense}]
%Let $k$ be an algebraically closed field containing $R$.
Fix a prime number $\ell\neq\car(k)$. We have
\begin{multline*}
\bigcup_{A,A' \in \detl} \left(\sg(k) \cap (X_A \times X_{A'})(k)\right) \\
 =  \sg(k) \cap \left(\bigcup_{A,A' \in \detl} (X_A \times X_{A'})(k)\right)
   \subset \sg(k).
\end{multline*}
By Theorem~\ref{thm:Sg-dense}, the set
$\bigcup_{A,A' \in \detl} \left(\sg(k) \cap (X_A \times X_{A'})(k)\right)$ is Zariski dense in
$$
\bigcup_{A,A' \in \detl} \left(X_A \times X_{A'}\right) =
    \left(\bigcup_{A \in \detl} X_A\right) \times \left(\bigcup_{A' \in \detl} X_{A'}\right),
    $$
    which by Theorem~\ref{thm:curves-dense} is Zariski dense in $\ag \times \ag$.
%  \begin{align*}
%    \sg(\C)
%    &\supseteq
%    \sg(\C) \cap \left(\bigcup_{A,A'} X_A \times X_{A'}\right)
%    \\
%    &=
%    \bigcup_{A,A'} \sg(\C) \cap (X_A \times X_{A'})
%    \\
%    &\prec
%    \bigcup_{A,A'} X_{A} \times X_{A'}
%    &&\text{By Theorem~\ref{thm:sg-c-dense}}
%    \\
%    &=
%    \left(\bigcup_{A} X_A\right) \times \left(\bigcup_{A'} X_{A'}\right)
%    \\
%    &\prec
%    \ag \times \ag
%    &&\text{By Theorem~\ref{thm:Sg-dense}}.
%  \end{align*}
\end{proof}


\begin{proof}[Proof of Theorem~\ref{thm:invariant-c-constant}]
  Consider the fiber product $\df = \ag \times_X \ag$.
  The universal property of $\df$ says that for any scheme $W$ and morphisms $h_1$ and $h_2$ from $W$ to $\ag$ such that $f \circ h_1 = f \circ h_2$, there is a unique morphism $h: W \to \df$ such that $h_1$ and $h_2$ factor through $h$.

  Let $k$ be an algebraically closed field containing $R$.
  Applying the universal property with $W = \Spec k$ shows that $\df(k)$ consists of the pairs $(A_1,A_2)$ of abelian varieties over $k$ such that $f(A_1) = f(A_2)$.
  By the hypothesis on $f$, if $A_1 \approx A_2$ then $f(A_1) = f(A_2)$. Hence $\sg(k) \subseteq \df(k)$.
  Since $\df$ is a closed subscheme of $\ag \times \ag$, Theorem~\ref{thm:sg-c-dense} implies that $\df = \ag \times \ag$, as desired.
\end{proof}



%\section{The curves $X_{A}$}
%\label{sec:curves-on-Ag}



%\textcolor{red}{TODO: what constraints are required for $n$?}. In this section we will construct the curves $X_A \subset \ag$. % mentioned in Section~\ref{sec:introduction}.

%We will define the maps $Y_0(\ell^n) \to \ag$ in two ways: geometrically based on the moduli interpretation, and complex analytically. We will use that these two interpretations are the same in the proof of Theorem~\ref{thm:sg-c-dense}. We will apply the moduli interpretation to prove Theorem~\ref{thm:Sg-dense}, and the complex analytic version to prove Theorem~\ref{thm:curves-dense}. Since the latter result does not directly carry over to positive characteristic, we will use a variant that shows density in $\ao^g$; see \ref{sec:characteristic-p}.



%If $(E, C) \in Y_0(N)$, let
%$$
%K(A) = (\ker \rho_A) \cap C^g  \subset E^g.
%$$

%Where is the next result used? If we use it, we should refer to it. If we don't use it, let's comment it out, for now.
%\begin{lemma}
%  The subgroup $K(A)$ is a maximal isotropic subgroup of $\ker \lambda_A$.
%\end{lemma}
%
%\begin{proof}
%  Let $P$ be a generator of $C$, defined over the algebraic closure of our base field. Identify $C^g$ with $(\Z/N)^g$ via the map $(a_iP) \mapsto (a_i)$. Then multiplication by the matrix $A$ induces a map $\lambda_A^{(C)}:C^g \to C^g$. One sees (how??) that $\#(\ker \lambda_A^{(C)}) = \sqrt{\#(\ker \lambda_A})$. Further, $\ker \lambda_A^{(C)} \subset C^g$ is isotropic (why?). The claim follows.
%\end{proof}

%Let $B = E^g/K(A)$, and let $\pi: E^g \to B$ be the quotient map. Then by \cite[Prop. 16.8]{milne-av}, there is a principal polarization $\lambda$ on $B$ for which $\pi^*(\lambda) = \lambda_A$. If $X$ is an abelian variety, let $NS(X)$ denote its N\'eron-Severi group. Since $\pi^*: NS(B) \to NS(E^g)$ is injective, $\lambda$ is unique.

%\begin{definition}\label{def:psimod-def}
%Define
%\[
%\psimod: Y_0(N) \to \ag, \quad (E,C) \mapsto (B,\lambda).
%\]
%\end{definition}



\section{Proof of Theorem~\ref{thm:Sg-dense}}
\label{sec:step-2}

%The main goal of this section is to prove Theorem~\ref{thm:Sg-dense}.

The plan is to find a suitable infinite set of pairs $(x,y) \in \sg(k) \cap (X_A \times X_{A'})(k)$. We will explicitly construct these pairs by choosing $x,y \in \ag(k)$ that are products of isogenous CM elliptic curves. To ensure both that our products are weakly isomorphic and that there are enough pairs, we first establish basic observations about ideals in CM fields.
\begin{lemma}\label{lem:silly}
  Suppose $\ell$ is a prime number. Then there is an imaginary quadratic field $K$ such that $\sO_K^\times = \{\pm 1\}$ and $\ell$ splits into principal prime ideals in $K$.
\end{lemma}
\begin{proof}
  Let $L$ denote the set of algebraic integers $\alpha \in \C$ whose minimal polynomial is of the form $x^2 - tx + \ell$ with $0 < |t| < 2\sqrt{\ell}$.
  Then $\#L = 4\lfloor 2\sqrt{\ell} \rfloor$.
  For any imaginary quadratic field $K$, there are at most $2\#(\sO_K^\times) \leq 12$ algebraic integers in $K$ of norm $\ell$.
 % Therefore $\#(K \cap L) \leq 12$.
  If $\ell \geq 13$, then $4\lfloor 2\sqrt{\ell} \rfloor > 24$, so there is some $\alpha \in L$ that does not lie in $\Q(i)$ or $\Q(\sqrt{-3})$, and we can let
   $K = \Q(\alpha)$.
  The cases when $\ell < 13$ can be checked by hand.
\end{proof}

\begin{lemma}\label{lem:K-exists}
  Suppose $\ell$ is a prime number, $g$ is a positive integer, and $K$ is an imaginary quadratic field over which $\ell$ splits into principal prime ideals, namely $\ell = \alpha\overline{\alpha}$ with $\alpha\in \sO_K$.
%  \begin{enumerate}
%    \item $\sO_K^\times = \{\pm 1\}$,
%    \item $\ell$ splits in $K$ into principal primes $\alpha\sO_K \cdot \overline{\alpha}\sO_K$ with $\alpha\in \sO_K$,
%    \item
Then there are infinitely many rational prime numbers $q$ such that
    \begin{enumerate}
      \item $q$ is inert in $K$,
      \item $q \equiv -1 \mod{g}$, and
      \item $\alpha \mod q\sO_K \in (\sO_K/q\sO_K)^\times$ is a $g$th power.
    \end{enumerate}
%  \end{enumerate}
\end{lemma}
\begin{proof}
  %By Lemma~\ref{lem:silly}, we can find a $K$ satisfying (1) and (2).
  Let $L = K(\zeta_g,\alpha^{1/g},\overline{\alpha}^{1/g})$.
  Let $\sigma$ be any complex conjugation in $\Gal(L/\Q)$.
  Let $\frak{q}$ be any prime of $L$ unramified in $L/\Q$ whose Frobenius $\mathrm{Frob}(\frak{q}) \in \Gal(L/\Q)$ is $\sigma$. The Chebotarev density theorem guarantees that there are infinitely many such $\frak{q}$.
  Let $q$ be the rational prime below $\frak{q}$.
  Since $\sigma|_K$ is complex conjugation, $q$ is inert in $K$, giving (1).
  Since $\sigma|_{\Q(\zeta_g)}$ is complex conjugation, $q \equiv -1 \pmod{g}$, giving (2).
%To see this, note that under the usual isomorphism $\Gal(\Q(\zeta_g)/\Q) \cong (\Z/g\Z)^\times$, complex conjugation is associated to $-1$. The map Frobenius element corresponding to $\frak{q} \cap \Q(\zeta_g)$ sends $\zeta_g \mapsto \zeta_g^c$.
Since $\sigma$ has order $2$, we have $\sO_L/\frak{q} \cong \sO_K/q\sO_K \cong \F_{q^2}$. In particular, $\alpha^{1/g}$ is a $g$th root of $\alpha$ in $(\sO_K/q\sO_K)^\times$, giving (3).
%Moreover, if $\sigma$ satisfies these conditions, then so does every conjugate of $\sigma$.
%By Chebotarev's density theorem, it remains to show that there exists some $\sigma \in \Gal(L/\Q)$ of order $2$ that restricts to complex conjugation in $K$ and $\Q(\zeta_g)$. Every complex conjugation in $\Gal(L/\Q)$ has these properties.
%  Choose any embedding $\iota: L \to \C$ and define $\sigma \in \Gal(L/\Q)$ by $a \mapsto \iota^{-1}(\overline{\iota(a)})$. Note that $\sigma$ has order $2$. Since $K$ and $\Q(\zeta_g)$ are CM fields, $\sigma$ restricts to the usual complex conjugation on them. Therefore $\sigma$ has the desired properties.
\end{proof}

We now establish properties of elliptic curves with CM by our imaginary quadratic field $K$.
\begin{definition}
  If $K$ is an imaginary quadratic field and $q$ is a prime number that is inert in $K$, let
  $$\Gt_q=(\sO_K/q\sO_K)^\times/(\Z/q\Z)^\times. $$
  %The field $K$ should be clear from the context.
\end{definition}

\begin{lemma}\label{lem:c-torsor}
  Suppose $E$ is an elliptic curve over an algebraically closed field $k$, and $\End(E) \cong \sO_K$ for some imaginary quadratic field $K$. Let $q$ be a prime number that is inert in $K$ and not equal to the characteristic of $k$. Then the set of subgroups of $E$ of order $q$ is a torsor over $\Gt_q$.
\end{lemma}
\begin{proof}
  Since $E[q]$ is a module over $\sO_K/q\sO_K \cong \F_{q^2}$  of size $q^2$, we have that $E[q] \cong \F_{q^2}$ as $\F_{q^2}$-vector spaces. So $\F_{q^2}^\times/\F_q^\times \cong \Gt_q$ acts freely and transitively on the one-dimensional $\F_q$-subspaces of $E[q]$.
\end{proof}

\begin{definition}[{\cite[Sec.~2]{kani2011products}}]\label{def:ker-idl}
  Suppose $A$ is an abelian variety over a field. If $I$ is a regular left ideal of $\End(A)$ (i.e., a left ideal that contains an isogeny), let $H(I) = \cap_{\phi \in I}\ker \phi$. If $H$ is a finite subgroup scheme of $A$, let $I(H) = \{\phi \in \End(A) \colon \phi(H) = 0\}$. A finite subgroup scheme $H$ of $A$ is an \emph{ideal subgroup} of $A$ if $H = H(I)$ for some ideal $I$ of $\End(A)$. A left ideal $I$ of $\End(A)$ is a \emph{kernel ideal} if $I = I(H)$ for some finite subgroup scheme $H$ of $A$.
\end{definition}

\begin{lemma}[{\cite[Prop.~23]{kani2011products}}]\label{lemma:order-ideal-subgroup}
  Suppose $E$ is a CM elliptic curve. If $H = H(I)$ is an ideal subgroup of $E$, then $\# H = [\End(E):I]$.
\end{lemma}

\begin{theorem}[{\cite[Thm.~20b]{kani2011products}}]\label{thm:kani-20b}
  Suppose $E$ is a CM elliptic curve over an algebraically closed field and $H$ a finite subgroup scheme of $E$. Then $H$ is an ideal %kernel
  subgroup if and only if %there is an inclusion $\End(E) \hookrightarrow \End(E/H)$.
  $\End(E) \subseteq \End(E/H)$. Moreover, if $H_1$ and $H_2$ are ideal subgroups of $E$, then $E/H_1 \approx E/H_2$ if and only if $I(H_1)$ and $I(H_2)$ are isomorphic as $\End(E)$-modules.
  %$f_{E_H} \mid f_E$
\end{theorem}

\begin{lemma}\label{lem:c-end}
  Suppose $E$ is an elliptic curve over an algebraically closed field, and $\End(E) = \sO_K$ for some imaginary quadratic field $K$. Suppose $q$ is a product of distinct prime numbers that are inert in $K$ and not equal to the characteristic of the base field, and suppose $\sC$ is a subgroup of $E$ of order $q$. Then $\End(E/\sC) = \Z + q\sO_K \subset \sO_K = \End(E)$. In particular, every endomorphism of $E/\sC$ is induced by an endomorphism of $E$ that takes $\sC$ to $\sC$.
\end{lemma}
\begin{proof}
  Let $q = \prod_{i=1}^n q_i$ be the prime factorization of $q$.
  %, where each $q_i$ is a prime inert in $K$ and not equal to the characteristic of the base field. We can write
  Then $\sC = \sum_{i=1}^n \sC_i$ where each $\sC_i$ is a subgroup of $E$ of order $q_i$. Let $E_j = E/\sum_{i=1}^j\sC_i$.
 
  The isogeny $\pi: E \to E/\sC$ factors into a chain of isogenies
   \[
    E
    \xrightarrow{\pi_1}
    E_1
    \xrightarrow{\pi_2}
    E_2
    \xrightarrow{\pi_3}
    \cdots
    \xrightarrow{\pi_n}
    E_n = E/\sC.
  \]
% \[
%    E
%    \xrightarrow{\pi_1}
%    E/\sC_1
%    \xrightarrow{\pi_2}
%    E/(\sC_1 + \sC_2)
%    \xrightarrow{\pi_3}
%    \cdots
%    \xrightarrow{\pi_n}
%    E/\sum_{i=1}^n\sC_i.
%  \]
  Let $\sO_j$ be the order $\End(E_j)$ in $K$, and let $f_j$ be its conductor, i.e., $f_j = [\sO_{K} : \sO_j]$. Since the isogeny $\pi_j$ has degree $q_j$, either $[\sO_j : \sO_{j-1}] = q_j$, or $[\sO_{j-1} : \sO_j] = q_j$, or $\sO_{j-1} = \sO_j$ \cite[Prop.~5]{kohel1996endomorphism}. Thus $f_j$ divides $\prod_{i=1}^{j}q_i$. Since the $q_i$ are distinct, $q_{j+1} \nmid f_j$. 
  % = [\sO_K : \sO_j]
  Since $q_j$ is inert in $K$, $\sO_K$ has no prime ideal of norm $q_j$. By \cite[Prop.~7.20]{cox2011primes}, there is a norm-preserving bijection between prime ideals of $\sO_{j}$ that do not divide $f_{j}$ and prime ideals of $\sO_K$ that do not divide $f_{j}$. Thus, $\sO_{j-1}$ has no prime ideal of norm $q_j$. 
By Lemma \ref{lemma:order-ideal-subgroup}, it follows that $\ker\pi_j$ is not an ideal subgroup of $E_{j-1}$. % \cite[Prop.~23]{kani2011products}. 
Now by Theorem~\ref{thm:kani-20b}, we must have $[\sO_{j-1} : \sO_j] = q_j$. Then $[\sO_K : \sO_n] = \prod_{i=1}^n q_i = q$, as required.
\end{proof}

\begin{lemma}\label{lem:c-subgps-distinct-quotients}
  Suppose $E$ is an elliptic curve over an algebraically closed field, and $\End(E) \cong \sO_K$ for some imaginary quadratic field $K$ with $\sO_K^\times = \{\pm 1\}$. Let $q$ be a prime not equal to the characteristic of the base field and inert in $K$. If $\alpha,\beta \in \sO_K$ are prime to $q$, then $E/\alpha(\sC) \approx E/\beta(\sC)$ if and only if $\alpha(\sC) = \beta(\sC)$.
\end{lemma}
\begin{proof}
 Since $\alpha(\sC) = (\alpha\overline{\beta})(\beta(\sC))$, after replacing $\beta(\sC)$ with $\sC$ and $\alpha\overline{\beta}$ with $\alpha$ it suffices to prove the claim for $\beta = 1$.

  If $\alpha(\sC) = \sC$, then $E/\alpha(\sC) \approx E/\sC$, so it suffices to show the converse.

  Let $\tilde{u}: E/\alpha(\sC) \to E/\sC$ be an isomorphism. %We want to show that $\sC = \alpha(\sC)$.
If $D$ is a subgroup of $E$, let $\pi_{D}$ denote the quotient map $E \to E/D$. Then $\alpha$ induces an isogeny $\tilde{\alpha}$
%: E/\sC \to E/\alpha(\sC)$ such that $\tilde{\alpha}\circ\pi_{\sC} = \pi_{\alpha(\sC)} \circ \alpha$. 
such that the left-hand square of the following diagram commutes.
$$
\xymatrix{
E \ar^{\alpha}[r]  \ar^{\pi_\sC}[d] \ar@/^1.6pc/^{\alpha'}[rr] & E \ar^{\exists u}[r]  \ar^{\pi_{\alpha(\sC)}}[d] & E \ar^{\pi_\sC}[d] \\
E/\sC \ar^-{\tilde{\alpha}}[r] & E/\alpha(\sC) \ar^-{\tilde{u}}[r] & E/\sC
}
$$
The map $\tilde{u}\circ\tilde{\alpha}$ is an endomorphism of $E/\sC$. By Lemma~\ref{lem:c-end}, $\tilde{u}\circ\tilde{\alpha}$ is induced by some $\alpha' \in \sO_K$ such that $\alpha'(\sC) = \sC$. That is, $\pi_{\sC}\circ\alpha' = \tilde{u}\circ\tilde{\alpha}\circ\pi_{\sC} = \tilde{u}\circ\pi_{\alpha(\sC)}\circ\alpha$.
  %This shows that $\deg(\alpha) = \deg(\alpha')$.
  Since $\alpha$ and $\alpha'$ are prime to $q = \#\sC$, we have
  \[
    \sC + \ker(\alpha')
    =
    \ker(\pi_{\sC} \circ \alpha')
    =
    \ker(\tilde{u}\circ\pi_{\alpha(\sC)}\circ\alpha)
    =
    \ker(\pi_{\alpha(\sC)}\circ\alpha)
    =
    \sC + \ker(\alpha),
  \]
  and $\ker(\alpha) = \ker(\alpha')$. Thus $\alpha' = u\alpha$ for some $u \in \sO_K^\times = \{\pm 1\}$. So $\alpha(\sC) = \pm\alpha'(\sC) = \pm\sC = \sC$, as desired.

  %Alternate proof of existence of u: $E/\alpha(\sC)$ and $E/\sC$ have a unique ascending isogeny. As $\tilde{u}$ is an isomorphism, it must send the ascending kernel of $E/\alpha(\sC)$ to that of $E/\sC$. The ascending kernel is the image of $E[c]$ under the quotient. Therefore $\pi^{\vee}\circ\tilde{u}\circ\pi_{\alpha(\sC)}$ is divisible by $c$, and so factors through an automorphism of $E$.
\end{proof}

\begin{lemma}\label{lem:prod-equiv-torsor}
  Suppose $E$ is an elliptic curve over an algebraically closed field, and $\End(E) \cong \sO_K$ for some imaginary quadratic field $K$ with $\sO_K^\times = \{\pm 1\}$. Let $q$ be a prime not equal to the characteristic of the base field and inert in $K$. Suppose $\sC$ is a subgroup of $E$ of order $q$. Suppose $\alpha_1,\dots,\alpha_g,\beta_1,\dots,\beta_g \in \sO_K$ are prime to $q$, and let $\alpha = \prod_{i=1}^g\alpha_i$ and $\beta = \prod_{i=1}^g\beta_i$. Then
  \[
    \prod_{i=1}^g E/\alpha_i(\sC) \approx \prod_{i=1}^g E/\beta_i(\sC)
    \,\Leftrightarrow\,
    \alpha \equiv \beta \text{ in } \Gt_q.
  \]
\end{lemma}
\begin{proof}
   Let $M$ be the diagonal matrix with diagonal entries $\alpha_1^{-1},\dots,\alpha_{g-1}^{-1}, \alpha_g^{-1}\alpha$. Note that $M\mod{q\sO_K} \in \Sl_g(\sO_K/q\sO_K)$. By \cite[Cor.~5.2]{ktheory1964bass}, there exists $M' \in \Sl_g(\sO_K)$ such that $M \equiv M' \mod{q\sO_K}$. The matrix $M'$ corresponds to an automorphism of $E^g$ that sends $\prod_{i=1}^g \alpha_i(\sC)$ to $\sC^{g-1} \times \alpha(\sC)$. A similar construction with $\beta$ shows that
  \[
    \prod_{i=1}^g E/\alpha_i(\sC) \approx \prod_{i=1}^g E/\beta_i(\sC)
    \,\Leftrightarrow\,
    \left(E/\sC\right)^{g-1} \times E/\alpha(\sC) \approx \left(E/\sC\right)^{g-1} \times E/\beta(\sC).
  \]

  Note that $\alpha$ induces an isogeny $\tilde{\alpha}: E/\sC \to E/\alpha(\sC)$. Let $\sO = \Z + q\sO_K$. By Lemma~\ref{lem:c-end} we have $\sO \cong \End(E/\sC)\cong \End(E/\alpha(\sC))\cong \End(E/\beta(\sC))$. Thus $\ker\tilde{\alpha}$ is an ideal subgroup by Theorem~\ref{thm:kani-20b}. The same holds for $\beta$ in place of $\alpha$.

  %I(\phi) = \{f \in \End(E/\sC) \colon \ker f \supseteq \ker \phi \}
  For an isogeny $\phi$ with domain $E/\sC$, let $I_\phi$ denote the kernel ideal of $\ker(\phi)$, i.e., $I_\phi = \{f \in \End(E/\sC) \colon f(\ker(\phi)) = 0\}$.
  By \cite[Thm.~46]{kani2011products},
  \begin{multline*}
    \left(E/\sC\right)^{g-1} \times E/\alpha(\sC) \approx \left(E/\sC\right)^{g-1} \times E/\beta(\sC)
    \\
    \Leftrightarrow
    \left(\bigoplus_{i=1}^{g-1} \sO\right) \oplus I_{\tilde{\alpha}} \cong \left(\bigoplus_{i=1}^{g-1} \sO\right) \oplus I_{\tilde{\beta}} \text{  as $\sO$-modules}.
  \end{multline*}
%  where the second isomorphism is as $\sO$-modules.
By \cite[Thm.~48]{kani2011products} (see also \cite[Rem.~49b]{kani2011products}), the latter isomorphism is equivalent to $I_{\tilde{\alpha}} \cong I_{\tilde{\beta}}$.
  By Theorem~\ref{thm:kani-20b},
  \[
    I_{\tilde{\alpha}} \cong I_{\tilde{\beta}}
    \,\Leftrightarrow\,
    E/\alpha(\sC) \approx E/\beta(\sC).
  \]
  By Lemma~\ref{lem:c-subgps-distinct-quotients},
  \[
    E/\alpha(\sC) \approx E/\beta(\sC)
    \,\Leftrightarrow\,
    \alpha(\sC) = \beta(\sC).
  \]
  By Lemma~\ref{lem:c-torsor}, $\alpha(\sC) = \beta(\sC)$ if and only if $\alpha \equiv \beta$ in $\Gt_q$.
\end{proof}

Recall the map $\psimod$ defined in \eqref{def:psimoddef}.

\begin{lemma}\label{lem:psimod-weakly-isomorphic-to-product}
Suppose $g\in\Z_{\ge 1}$, and $A$ is a $g \times g$ symmetric, positive definite integer matrix whose determinant $N$ is not divisible by the characteristic of our base. %(Later we will take $N$ to be a power of a prime $\ell$.)
Suppose $(E,C) \in Y_0(N)$, and let $\psimod(E,C) = (B,\lambda)$.  Let $d_1, \cdots, d_g$ be the elementary divisors of $A$, and for $1 \le i \le g$ let $E_i = E/(N/d_i)C$. Then
$
    B \approx E_1 \times \cdots \times E_g.
$
\end{lemma}

\begin{proof}
  Let $D$ be the diagonal matrix with $d_1, \cdots, d_g$ on the diagonal.
%   \[
%     D =
%    \begin{bmatrix}
%      {d_1} & & & \\
%      & {d_2} & & \\
%      & & \ddots & \\
%      & & & {d_{g}}
%    \end{bmatrix}
%  \]
Then $D$ is the Smith normal form of $A$, and there exist $U,V \in \Gl_g(\Z)$ such that $A = UDV$.
If $M \in \Gl_g(\Z)$, let $\rho_M$ denote the natural endomorphism of $E^g$ induced by $M$.
Then %$\rho_U$ and $\rho_V$ are automorphisms of $E^g$ induced by $U$ and $V$, respectively, and
$\rho_A = \rho_U \rho_D \rho_V$. Since
  \begin{align*}
    \ker \rho_D &= E[d_1] \times E[d_2] \times \cdots \times E[d_g]
  \end{align*}
  we have $(\ker \rho_D) \cap C^g = \prod_{i=1}^g (\frac{N}{d_i}C)$. 
 Since $\rho_V(C^g) = C^g$, we now have
  \[
    \rho_V((\ker \rho_A) \cap C^g) = (\ker \rho_D) \cap C^g.
  \]
  Thus the quotients of $E^g$ by $(\ker \rho_A) \cap C^g$ and by $(\ker \rho_D) \cap C^g$ are weakly isomorphic. The lemma follows.
\end{proof}

\begin{lemma}\label{lem:lim-degree}
Let $k$ be an algebraically closed field containing the base ring.
  Let $\ell$ be a prime not equal to $\car(k)$. 
  Suppose $A,A' \in \detl$, $\det(A) = \ell^n$, and $\det(A') = \ell^m$.
  %M_{g \times g}(\Z)$ be positive definite symmetric matrices such that $\det(A) = \ell^n$ and $\det(A') = \ell^m$ for a prime $\ell$. Let $X_A$ and $X_{A'}$ denote the images of the maps $\psi_A: Y_0(\ell^n) \to \ag$ and $\psi_{A'}: Y_0(\ell^m) \to \ag$.
  Then there exists a sequence $x_i \in Y_0(\ell^n)(k)$ such that
  \[
    \lim_{i \to \infty}\#\left\{ y \in Y_0(\ell^m)(k) \colon \psi_A(x_i) \approx \psi_{A'}(y) \right\} = \infty.
  \]
\end{lemma}
\begin{proof}
  For every imaginary quadratic field $K$ as in Lemma~\ref{lem:silly}, there exist a principal prime $\alpha\sO_K$ lying over $\ell$ and rational primes $q_i$ as in Lemma~\ref{lem:K-exists}. We may assume $q_i \neq \ell$ for all $i$. Let $E$ be an elliptic curve over an algebraically closed field such that $\End(E) \cong \sO_K$.

  If $\sC$ is a cyclic subgroup of $E$ of order prime to $\ell$, then $\alpha$ induces a chain of isogenies
  \[
    E/\sC \to E/\alpha(\sC) \to \cdots \to E/\alpha^n(\sC).
  \]
  Let $\alpha_{\sC,n}: E/\sC \to E/\alpha^n(\sC)$ be the composition of this chain. Then $\alpha_{\sC,n}$ is a cyclic $\ell^n$-isogeny, so the pair $(E/\sC,\alpha_{\sC,n})$ defines a point in $Y_0(\ell^n)(k)$.

    For each $i$, fix a cyclic subgroup $\sC_i$ of $E$ of order $q_i$. Define $x_1$ to be $(E/\sC_1,\alpha_{\sC_1,n})$, $x_2$ to be $(E/(\sC_1 + \sC_2), \alpha_{\sC_1 + \sC_2,n})$, and so on. The $x_i$ are distinct points, since the curves all have different endomorphism rings by Lemma~\ref{lem:c-end}.

%    Next we will construct the values of $y \in Y_0(\ell^m)$ such that $\psi_{A'}(y) \approx \psi_{A}(x_i)$. We first focus on the case $i = 1$.
Let $\ell^{n_1},\dots,\ell^{n_g}$ be the elementary divisors of $A$  and let $\ell^{n_1'},\dots,\ell^{n_g'}$ be the elementary divisors of $A'$.
By Lemma~\ref{lem:psimod-weakly-isomorphic-to-product} we have $$\psi_{A}(x_1) \approx E/\alpha^{n_1}(\sC_1) \times \cdots \times E/\alpha^{n_g}(\sC_1).$$
    %By our choice of $K$, $\alpha$ is a $g$th power in $\sO_K/q_1\sO_K$, so we can find $\gamma \in \sO_K$ such that $\alpha \equiv \gamma^g \mod{q_1\sO_K}$. By Lemma~\ref{lem:c-torsor}, $\alpha(\sC_1) = \gamma^g(\sC_1)$ and
%    \[
%      \psi_{A}(x_1) \approx E/\gamma^{gn_1}(\sC_1) \times \cdots \times E/\gamma^{gn_g}(\sC_1).
%    \]
    Let $S$ denote a set of representatives $\beta \in \sO_K$ of the solutions to %the equation
    \[
      \alpha^{n_1 + \cdots + n_g} \equiv \beta^g\alpha^{n_1' + \cdots + n_g'}
      \text{ in } \Gt_{q_1}.
    \]
Since $\alpha$ is a $g$-th power in  $(\sO_K/q_1\sO_K)^\times$, and  $g$ divides the order $q_1 + 1$ of the cyclic group $\Gt_{q_1}$,
   we have $\#S = g$. For all $\beta \in S$, let $y_\beta = (E/\beta(\sC_1),\alpha_{\beta(\sC_1),m})$. By Lemma~\ref{lem:psimod-weakly-isomorphic-to-product} we have $$\psi_{A'}(y_\beta) = E/\alpha^{n_1'}(\beta(\sC_1)) \times \cdots \times E/\alpha^{n_g'}(\beta(\sC_1)).$$ Thus $\psi_A(x_1) \approx \psi_{A'}(y_\beta)$ by Lemma~\ref{lem:prod-equiv-torsor}. By Lemma~\ref{lem:c-subgps-distinct-quotients} the $y_\beta$ are distinct. This gives $g$ points $y \in Y_0(\ell^m)(k)$ with $\psi_{A}(x_1) \approx \psi_{A'}(y)$.

  For $x_2$, we use a similar construction. By the Chinese remainder theorem, the set of subgroups of $E$ of order $q_1q_2$ is a torsor over $\Gt_{q_1} \times \Gt_{q_2}$. Finding $\beta \in \sO_K$ such that
  \[
    \psi_{A}(x_2) \approx \psi_{A'}\left(E/\beta(\sC_1+\sC_2),\alpha_{\beta(\sC_1+\sC_2),m}\right)
  \]
  reduces to finding solutions $\beta$ to %the equation
  \[
    \alpha^{n_1 + \cdots + n_g} \equiv \beta^g\alpha^{n_1' + \cdots + n_g'}
    \text{ in } \Gt_{q_1} \times \Gt_{q_2}.
  \]
%  Here $\gamma$ is chosen such that $\alpha \equiv \gamma^g \mod{q_1q_2\sO_K}$.
There are precisely $g^2$ solutions $\beta$. Continuing this construction for $i=3,4,\dots$, we find that for each $i$ there are $g^i$ points $y \in Y_0(\ell^m)(k)$ such that $\psi_{A}(x_i) \approx \psi_{A'}(y)$.
\end{proof}

\begin{proof}[Proof of Theorem~\ref{thm:Sg-dense}]
  Let $S$ denote the Zariski closure of $\sg(k) \cap (X_A \times X_{A'})(k)$ in $X_A \times X_{A'}$. By Lemma~\ref{lem:lim-degree}, the set $\sg(k) \cap (X_A \times X_{A'})(k)$ has an infinite number of geometric points. Thus $\dim S \geq 1$. Suppose $\dim S = 1$, so that $S$ is a finite union of curves $\cup S_i$. The $S_i$ cannot all be horizontal components---that is, of the form $X \times \{z\}$---since this would contradict Lemma~\ref{lem:lim-degree}. Let $S'$ be $S$ with the horizontal components removed. By Lemma~\ref{lem:lim-degree}, the projection map $\pi_X: S' \to X$ has unbounded degree. But $\pi_X$ on each irreducible component of $S'$ is nonconstant, so $\pi_X|_{S'}$ has finite degree. This contradiction shows that $\dim S \geq 2$, and the desired result follows.
\end{proof}







\section{Proof of Theorem \ref{thm:arbit-char}}
\label{sec:characteristic-p}



Suppose $A$ is a $g \times g$ diagonal matrix whose diagonal entries are positive integers, and let $N = \det A$. Observe that the map $\psimod: Y_0(N) \to \ag$ factors through the map $\ao^g \to \ag$ that sends a tuple of polarized elliptic curves $(E_1,\dots,E_g)$ to the product $E_1 \times \cdots \times E_g$ with the product polarization. Write
\[
\psidiag: Y_0(N) \to \ao^g
\]
for the associated morphism. Let $d_1, \ldots, d_g$ be the diagonal entries of $A$. If $(E, C) \in Y_0(N)$, then
\[
  \psidiag(E,C) = E_1 \times \cdots \times E_g
\]
where  $E_i := E/\frac{N}{d_i}C$.
Let $$X^{(1)}_A = \psidiag(Y_0(N)).$$

%\begin{definition}
  If $g$ is a positive integer and $\ell$ is a prime number, let $W_{\ell,g}$ denote the set of all $g \times g$ diagonal matrices with diagonal entries $\ell^{n_1},\dots,\ell^{n_g}$ for some positive integers $n_1,\dots,n_g$. 
%\end{definition}

\begin{theorem}\label{thm:curves-dense-a1}
    If $g \in \Z_{>0}$ then there exists a prime number $\ell$ not equal to the characteristic of the base ring such that $\bigcup_{A\in W_{\ell,g}} X^{(1)}_A$ is Zariski dense in $\ao^g$.
\end{theorem}
\begin{proof}
 Let $k$ be an algebraically closed field containing the base ring. Let $E_0$ be an elliptic curve over $k$ with CM by $\sO_K$ for some imaginary quadratic field $K$. Choose a prime $\ell\neq\car(k)$ that is inert in $K$, and fix a subgroup $\sC_0$ of $E_0$ of order $\ell$. Let $\pi_0$ denote the quotient map $E_0 \to E_0/\sC_0 =: E_1$. Since $\End(E_0)$ has no ideal of norm $\ell$, $\sC_0$ is not an  ideal subgroup of $E_0$ by Lemma~\ref{lemma:order-ideal-subgroup}. Theorem~\ref{thm:kani-20b} and~\cite[Prop.~5]{kohel1996endomorphism} then implies that $\End(E_1) \cong \Z + \ell\sO_K$.

 For $i \ge 1$, let $\sC_i$ be any subgroup of $E_i$ of order $\ell$ other than the kernel of the dual isogeny $\pi_{i-1}^\vee$, and let $\pi_i$ be the quotient map $E_i \to E_i/\sC_i =: E_{i+1}$. In order to show that the $E_i$ are non-isomorphic, we will show inductively that $\End(E_{i+1}) \cong \Z + \ell^{i+1}\sO_{K}$. Since $\End(E_{i}) \subset \End(E_{i-1})$, Theorem~\ref{thm:kani-20b} implies that $\ker \pi_{i-1}^\vee$ is an ideal subgroup. Since $\End(E_{i}) \cong \Z + \ell^{i}\sO_{K}$, the only ideal of index $\ell$ in $\End(E_{i})$ is $\ell\Z + \ell^i\sO_K$. From Lemma~\ref{lemma:order-ideal-subgroup} and the uniqueness of the ideal of index $\ell$, it follows that $\ker \pi_{i-1}^\vee$ is the unique ideal subgroup of order $\ell$, namely $H(\ell\Z + \ell^i\sO_K)$. The subgroup $\sC_i$ therefore cannot also be an ideal subgroup of $E_i$. By Theorem~\ref{thm:kani-20b}, $\End(E_{i+1})$ must be strictly smaller than $\End(E_{i})$. The latter observation together with \cite[Prop.~5]{kohel1996endomorphism} implies $[\End(E_i):\End(E_{i+1})] = \ell$, and hence $\End(E_{i+1}) \cong \Z + \ell^{i+1}\sO_{K}$.

  Let $S = \{E_i\}_{i=0}^\infty$. Let $(E_{n_1},\dots,E_{n_g}) \in S^g$ and let $A$ be the diagonal matrix with diagonal entries $\ell^{n_1},\dots,\ell^{n_g}$.  Choose any $n > \max\{n_i\}$, and let $\sC = \ker \pi^{(n)}$. Then $(E_0,\pi^{(n)}) \in Y_0(\ell^n)(k)$ and
 \[
   \psidiag(E_0,\sC) = E_{n_1} \times \cdots \times E_{n_g}.
 \]
Thus, $S \subset \bigcup_A X^{(1)}_A(k)$. Since $S$ is an infinite set of non-isomorphic elliptic curves, $S$ is dense in $\ao$. Therefore $S^g$ is dense in $\ao^g$.
\end{proof}

\begin{theorem}\label{thm:Sg-dense-a1}
  Suppose $g\in\Z_{\ge 2}$, $k$ is an algebraically closed field, and $\ell$ is a prime number not equal to the characteristic of $k$. If $A$ and $A'$ are diagonal matrices in $\detl$, then $\sg^{(1)}(k) \cap (X^{(1)}_A \times X^{(1)}_{A'})(k)$ is Zariski dense in $X^{(1)}_A \times X^{(1)}_{A'}$.
\end{theorem}

\begin{proof}
  The proof is the same as the proof of Theorem~\ref{thm:Sg-dense}, only replacing $\ag$ with $\ao^g$, and $\psimod$ with $\psidiag$.
\end{proof}

\begin{proof}[Proof of Theorem~\ref{thm:arbit-char}]
  The proof of Theorem~\ref{thm:arbit-char} is almost the same as Theorem~\ref{thm:invariant-c-constant}, replacing $\ag$  with $\ao^g$, and invoking Theorems~\ref{thm:Sg-dense-a1} and  Theorem~\ref{thm:curves-dense-a1} in place of Theorems~\ref{thm:Sg-dense} and \ref{thm:curves-dense}, respectively.
  %with analogs that work with $\ao^g$ instead of $\ag$. Theorem~\ref{thm:curves-dense-a1} is an analogue of Theorem~\ref{thm:curves-dense}, and Theorem~\ref{thm:Sg-dense-a1} is an analog of Theorem~\ref{thm:Sg-dense}.
\end{proof}








\section{Proof of Theorem~\ref{thm:curves-dense}}
\label{sec:step-1}

\begin{lemma}\label{lem:sl-dense}
  If $N$ is a positive integer, then $\Sl_g(\Z[1/N])$ is dense in $\Sl_g(\R)$.
\end{lemma}
\begin{proof}
  Let $G \in \Sl_g(\R)$. Factor $G$ as a product of elementary matrices $G = E_n \cdots E_2 E_1$, where $\det E_i = \pm 1$. For each $E_i$, with at most one exception the entries are $0$ or $\pm 1$. Thus there exists a $g \times g$ matrix $E_i'$ with entries in $\Z[1/N]$ and $\det E_i' = \det E_i$ that is arbitrarily close to $E_i$. Let $G' = E_n' \cdots E_1' \in \Sl_g(\Z[1/N])$. Since matrix multiplication is continuous, $G'$ can be made arbitrarily close to $G$.
\end{proof}

\begin{lemma}\label{lem:rggt-dense}
  If $N$ and $g$ are positive integers, then the set
\[
\{ rGG^t \colon r \in \R^+ \text{ and } G \in \Sl_g(\Z[1/N]) \}
\]
is dense in the set of $g \times g$ real, symmetric, positive definite matrices.
\end{lemma}
\begin{proof}
  Let $A$ be a $g \times g$ real, symmetric, positive definite matrix. Then there exists an orthogonal matrix $O$ such that $D = OAO^t$ is diagonal and has positive entries. Let $H = \det(D)^{-1/2}O\sqrt{D}$ so that $A = \det(D)HH^t$. Note that $H \in \Sl_g(\R)$, so by Lemma~\ref{lem:sl-dense}, there exists $G \in \Sl_g(\Z[1/N])$ arbitrarily close to $H$, and therefore $\det(D)GG^t$ can be made arbitrarily close to $A$.
\end{proof}

\begin{definition}
  A $g \times g$ matrix $Q$ is \emph{half-integral} if $2Q_{ij} \in \Z$ and $Q_{ii} \in \Z$ for all $1 \leq i,j \leq g$, where $Q_{ij}$ denotes the $i,j$ entry of $Q$.
\end{definition}

\begin{lemma}\label{lem:finite-fixed-trace}
 Fix $t\in\R$. Then there are finitely many $g \times g$ symmetric, positive semi-definite, half-integral matrices $Q$ such that $\tr(Q) \leq t$.
\end{lemma}
\begin{proof}
  Suppose $Q$ is a symmetric, positive semi-definite, half-integral matrix with $\tr(Q) \leq t$. Let $\lambda_1,\dots,\lambda_g$ be the eigenvalues of $Q$. Since $\lambda_i \geq 0$, we have
  \[
    \sum_{1 \leq i,j \leq g} Q_{ij}^2 = \tr(Q^2) = \sum_{i=1}^g \lambda_i^2 \leq \left(\sum_{i=1}^g \lambda_i\right)^2 = \tr(Q)^2 \leq t^2.
  \]
  This shows that $Q$, as a vector in $\R^{g^2}$, lies in the ball of radius $t$. Thus the number of possible $Q$ is bounded by the number of half-integral points in the ball of radius $t$ in $\R^{g^2}$, which is finite.
\end{proof}

% \begin{lemma}\label{lem:bound-trace-finite}
%  For any positive definite symmetric real $g \times g$ matrix $A$ and $t \in \R$, the set of symmetric, positive semi-definite, half-integral $g \times g$ matrices $Q$ such that $\tr(AQ) \leq t$ is finite.
% \end{lemma}
% \begin{proof}
%  Recall that $\langle x,y \rangle = \tr(xy^t)$ is an inner product on the space of real matrices. Moreover, if $B$ is any positive semidefinite matrix, then $\tr(B^2) \leq \tr(B)^2$. So
%  \begin{align*}
%    \tr(BQ)^2 &\leq \tr(B^2)\tr(Q^2)
%    &&\text{by Cauchy–Schwarz}
%    \\
%    &\leq \tr(B)^2\tr(Q)^2
%    &&\text{By positive semidefinite.}
%    %\tr(B^2) = \sum \lambda_i^2 \leq \left(\sum \lambda_i\right)^2 = \tr(B)^2.
%  \end{align*}
%  Therefore, if $\tr(AQ) \leq t$, then
%  \[
%    \tr(Q) = \tr(A^{-1}AQ) \leq \tr(A^{-1})\tr(AQ) \leq \tr(A^{-1})t.
%  \]
%  The claim then follows from Lemma~\ref{lem:finite-fixed-trace}.
% \end{proof}

\begin{lemma}\label{lem:unique-minimizer}
  Suppose $S$ is a nonempty set of symmetric, positive semi-definite, half-integral $g \times g$ matrices. Then there exists an open cone of positive definite, real, symmetric, $g \times g$ matrices $A$ such that $\displaystyle\min_{Q \in S}\tr(AQ)$ is achieved by a unique $Q\in S$.
\end{lemma}
\begin{proof}
Let $t_0 = \displaystyle\min_{Q \in S}\tr(Q)$.
  Since $\{Q \in S \colon \tr(Q) \leq t\}$ is finite for all $t \in \R$ by Lemma~\ref{lem:finite-fixed-trace},
  there is a gap between $t_0$ and the next smallest value $t_1$ of $\tr(Q)$ for $Q \in S$. Let $S_0 = \{Q \in S \colon \tr(Q) = t_0\}$.

  Let $\mathfrak{S}$ be the set of real symmetric $g \times g$ matrices $E$ such that
  \begin{enumerate}
    \item $\tr(EQ_i) \neq \tr(EQ_j)$ for all distinct $Q_i,Q_j \in S_0$,
    \item $E$ is positive definite, and
%    \item $I+E$ is positive definite (this follows from (2), so omit it),
    \item $\tr(EQ) < t_1 - t_0$ for all $Q\in S_0$.
  \end{enumerate}
  To see that $\mathfrak{S}$ is non-empty, observe that (1) describes the complement of a finite union of hyperplanes, which is a dense set. Therefore there is a real symmetric matrix $E$ satisfying both (1) and (2). Scaling by a sufficiently small $\varepsilon > 0$, we can guarantee (3) as well.

  Let $C = \R^+(I + \mathfrak{S})$, where $I$ is the $g \times g$ identity matrix. By definition, $C$ is a cone. The set $C$ is open because $\mathfrak{S}$ is defined as a finite intersection of open subsets.

  Suppose $A \in C$; that is, $A = r(I+E)$ for some $r \in \R^+$ and $E \in \mathfrak{S}$. Let $Q \in S$. Since $E$ and $Q$ are positive semi-definite, $\tr(EQ)\ge 0$. Property (3) now implies that $\tr((I+E)Q)$ is minimized only when $Q \in S_0$. Hence by (1) we have that $\tr((I+E)Q)$ is minimized for a unique $Q \in S$. Since $E$ is positive definite, so is $I+E$, and hence $I + E$ satisfies the conclusion of the lemma. By linearity of the trace, $A$ also satisfies the conclusion of the lemma, and the claim follows.
\end{proof}

%In ?? we will compute pullbacks of modular forms. It is convenient (instead, say what we mean?) to reduce the computation [what computation?] to one over $\C$.
Let $\hh$ denote the complex upper half plane and let $\hh_g$ denote the degree $g$ Siegel upper half space. Recall that $\Sp_{2g}(\Z)$ (resp., $\Gamma_0(N)$) acts on $\hh_g$ (resp., $\hh$) by fractional linear transformations,
 $Y_0(N) = \hh/\Gamma_0(N)$, and $\ag = \hh_g/\Sp_{2g}(\Z)$.
\begin{lemma}\label{lem:psi-A-n}
Suppose that $A$ is a $g \times g$ symmetric, positive definite integer matrix and $N = \det A$.
Then the map \[
  \hh \to \hh_g, \quad  \tau \mapsto \tau A
\]
%descends to 
induces a morphism of $\C$-schemes
$
  \psimodt: Y_0(N) \longrightarrow \ag.
$
\end{lemma}

\begin{proof}
Let
\[
\sigma = \begin{bmatrix} a & b \\ c & d \end{bmatrix} \in \Gamma_0(N) \text{ and } M = \begin{bmatrix} aI_g & bA \\ cA^{-1} & dI_g \end{bmatrix}
\]
where $I_g$ denotes the $g \times g$ identity matrix.
If $\tau \in \hh$, a direct computation shows that $M \in\Sp_{2g}(\Z)$
% it is integral because \det(A) | c, so cA^{-1} is integral.
% M is in Sp because then M^t*\Omega*M = M
% where \Omega = \begin{matrix} 0 & I \\ -I & 0 \end{matrix}
and  $\sigma(\tau)A = M(\tau A)$.
%(It's well-defined. Why is it a morphism?)
\end{proof}

Recall the definition of $\psimod$ in \eqref{def:XAdef}.

%In fact, $\psimodt$ is none other than $\psimod$, from which one can obtain an alternative proof of Lemma \ref{lem:psi-A-n}.
\begin{lemma}\label{lemma:psimod-over-c}
Suppose that $g\in\Z_{>0}$, $\ell$ is a prime, $A \in \detl$, and
 the base scheme is $\C$. Then $\psimod = \psimodt$.
\end{lemma}

\begin{proof}
Let  $N = \det A$.  Suppose $(E, C) \in Y_0(N)$. There exists $\tau \in \hh$ such that $E = \C/(\Z + \tau \Z)$ and $C = \langle 1/N \rangle$. We first show that $\psimodt(E,C) \approx \psimod(E,C)$.

  Let $\Lambda = \Z^g + \tau \Z^g \subset \C^g$. Then $\C^g/\Lambda = E^g$.
  %, where projection on the $i$th complex coordinate is the same as projection onto the $i$th factor of $E^g$. 
  Let
  \[
    \tla = \Z^g + \tau A \Z^g \quad \text{ and } \quad     \Lambda_A = A^{-1}\Z^g + \tau \Z^g.
  \]
By definition, $\psimodt(\tau) \approx \C^g/\tla$.
%  \[
%    \Lambda_A = A^{-1}\Z^g + \tau \Z^g.
%  \]
%  Multiplication by $A^{-1}: \C^g \to \C^g$ induces an isomorphism
%  \[
 %   \C^g/\tla \xrightarrow{\sim} \C^g/\Lambda_A.
 % \]
 Since $\Lambda \subset \Lambda_A$, there is a natural isogeny
  \[
    \rho: E^g = \C^g/\Lambda \to \C^g/\Lambda_A.
  \]
%  We wish to compute $\ker \rho$.

  Multiplication by $A: \C^g \to \C^g$ induces an isomorphism
  \[
     \C^g/\Lambda_A \xrightarrow{\sim}  \C^g/\tla
  \]
and an isogeny
  \[
    \lambda_A: \C^g/\Lambda \longrightarrow \C^g/\Lambda,
  \]
  %This is the same isogeny $\rho_A$ as in the proof of Lemma \ref{lem:psimod-weakly-isomorphic-to-product}; i.e., it
  where $\lambda_A$ is the natural isogeny $E^g \to E^g$ induced by the matrix $A$. Then
\[
\ker \lambda_A = A^{-1}\Z^g + \tau A^{-1} \Z^g \pmod{\Lambda}
\]
%With our identification $E = \C/(\Z + \tau\Z)$, recall that the distinguished subgroup $C \subset E$ is $\langle 1/N \rangle$. Then $C^g \subset E^g$ is $\frac{1}{N}\Z^g \pmod{\Lambda}$. It follows that
and
\[
\ker \rho = (\ker \lambda_A) \cap C^g. % = (\ker \lambda_A) \cap C^g.
\]
Since $\psimod(E,C) \approx E^g/((\ker \lambda_A) \cap C^g)$, it follows that $\psimod(E,C) \approx \psimodt(E,C)$.

  A polarization on a $g$-dimensional complex abelian variety $\C^g/(\Z^g + \Omega \Z^g)$ with $\Omega \in \hh_g$ is given by an alternating Riemann form $\sE: \C^g \times \C^g \to \R$ as in~\cite{rosen-avc}. The standard form $\sE$ is the unique map satisfying $\sE(u,\Omega v) = u^tv$ for all $u,v \in \Z^g$. 
  %We call this form the \emph{Siegel alternating form} arising from $\Omega \in \hh_g$; this form specifies the principal polarization for the class of $\Omega$ in $\ag$. %For example, if $\Omega = \tau I$ for $\tau \in \hh$, so that the abelian variety is $E^g$, then the Siegel alternating form represents the product principal polarization.

Now consider the (non-principal) polarization $\lambda_A$ on $E^g = \C^g/\Lambda$. The corresponding alternating Riemann form is given by $\sE_A(u,\tau v) = u^tAv$ for all $u,v \in \Z^g$. Since $\sE_A(\Lambda_A \times \Lambda_A) \subset \Z$, it follows that $\sE_A$ is an alternating Riemann form for $\C^g/\Lambda_A$ as well. 
%Write $\lambda$ for the polarization of $\C^g/\Lambda_A$ given by $E_A$. 
Since the polarization $\sE_A$ descends from $\lambda_A$, and the polarization coming from $\psimod$ is the unique polarization also descending from $\lambda_A$, we have
\[
  \psimod(E,C) = (\C^g/\Lambda_A, \sE_A).
\]
%Let $\tilde{\lambda}$ be 
Let $\tilde{\sE}$ denote the %polarization coming from the 
%Siegel alternating form for $\tau A$; that is, given by the 
alternating Riemann form %$E_{\tau A}$ 
that satisfies %$E_{\tau A}(u, \tau A v) = u^tv$
$\tilde{\sE}(u, \tau A v) = u^tv$ for all $u,v \in \Z^g$. If $u, v \in \Z^g$, then
%\begin{align*}
$$  \tilde{\sE}(u, \tau A v) = u^tv 
                          = \sE_A(A^{-1}u, \tau v) 
                          = \sE_{A}(A^{-1}u, A^{-1}\tau Av).$$
%\end{align*}
Thus multiplication by $A$ on $\C^g$ induces an isomorphism of polarized abelian varieties
\[
  \psimod(E,C) = (\C^g/\Lambda_A, \sE_A) \xrightarrow{\sim} (\C^g/\tla, \tilde{\sE}) = \psimodt(E,C),
\]
%Since $\psimodt(E,C) = (\C^g/\tla, \tilde{\lambda})$,
as desired.
 % Further, this polarization is specified by letting the columns be a symplectic basis for the associated Riemann form $H: \C^g \times \C^g \to \C$; this is precisely the product polarization.
 %  The abelian variety $B$ associated to $\psic(\tau)$ is $\C^g/\tilde{\Lambda}$, where $\tilde{\Lambda}$ is the lattice generated by the columns of
 %  \[
 %    \begin{bmatrix}
 %      I | \tau A
 %    \end{bmatrix},
 %  \]
 %  and with the associated principal polarization.
\end{proof}

%\begin{definition}
Suppose $g$ is a positive integer.
   Let $D$ denote the set of $g \times g$ symmetric, half-integral, positive semidefinite matrices. 
   If $f$ is a Siegel modular form on $\ag$, $\ell$ is a prime not equal to the characteristic of the base, and $A\in \detl$, let $\psimod^*(f) = f \circ \psimod$ denote the pullback modular form on $X_0(\det(A))$.
%\end{definition}

\begin{lemma}\label{lemma:q-expansion}
  Suppose  $g \in \Z_{\ge 1}$, $f$ a Siegel modular form on $\ag$, and $\ell$ is a prime number not equal to the characteristic of the base ring $R$. 
  %Let $\infty \in X_0(N)$ be the unique cusp with type $I_1$ reduction. 
  Then for all $Q\in D$ there exist $c_Q \in R$ such that for all $A \in \detl$, the $q$-expansion of 
  %the modular form 
  $\psimod^*(f)$ at $\infty$ is of the form
  \[
    \sum_{Q \in D} c_Q q^{\tr(AQ)}.
  \]
%  where the sum is over symmetric half-integral positive semidefinite matrices $Q$.
\end{lemma}

\begin{proof}
  We first prove the result over $\C$. Let $\overline{\ag}$ be a toroidal compactification of $\ag$. Let $A \in \detl$ have determinant $N$. The rational map $\psimod$ extends to a morphism $X_0(N) \to \overline{\ag}$. Let $\tau_{ij}$ (resp.~$\tau$) with $1 \leq i \leq j \leq g$ be the standard coordinates for $\hh_g$ (resp.~$\hh$), and let $q_{ij}$ (resp.~$q$) be $e^{2\pi i \tau_{ij}}$ (resp.~$e^{2\pi i \tau}$). By Lemma~\ref{lemma:psimod-over-c}, $\psimod^*(q_{ij}) = q^{A_{ij}}$. Setting $q_{ji} = q_{ij}$, the modular form $f$ has an expansion of the form
    \[
      \sum_{Q \in D} c_Q \prod_{i,j=1}^g q_{ij}^{Q_{ij}}.
    \]
    Thus at the cusp at infinity of $X_0(N)$, the $q$-expansion of $\psimod^*(f)$ is
%  \begin{align*}
    $$\sum_{Q \in D} c_Q \prod_{i,j=1}^g q^{A_{ij}Q_{ij}} = \sum_{Q \in D} c_Q q^{\sum_{i,j=1}^g A_{ij}Q_{ij}} 
    = \sum_{Q \in D} c_Q q^{\tr(AQ)}.$$
%  \end{align*}
  Observe furthermore that the cusp at infinity on $X_0(N)$ corresponds to type $I_1$ reduction. % The independence from $A$ is immediate.

  Now consider an arbitrary base $R$. By~\cite[IV.5.15]{faltings1990degeneration}, there is a toroidal compactification $\agz$ for $\ag$ over $\Z$ whose base-extension to $\C$ is $\overline{\ag}$. By abuse of notation, we will write $\overline{\ag}$ for the base-extension of $\agz$ to $R$. As before, the rational map $\psimod$ extends to a morphism $X_0(N) \to \overline{\ag}$.
  
  Let $Y = \Z$ be the character group of the torus $\G_m$, and $X = \Z^g$ the character group of the torus $\G_m^g$. Let $\{ q_{ij}\}_{1 \leq i \leq j \leq g}$ be a basis for $S^2(X)$, the symmetric quotient of $X \otimes X$, and let $q$ be a basis for $S^2(Y)$. Here, we write $S^2(X)$ and $S^2(Y)$ as multiplicative groups. As in \cite[Section V.1]{faltings1990degeneration}, a $q$-expansion for $f$ is a power series in $R[[S^2(X)]]$, and similarly a $q$-expansion for $\psimod^*(f)$ is a power series in $R[[S^2(Y)]]$. To prove that $\psimod^*(f)$ has the desired $q$-expansion, we need to know the induced map $\psimod^*: S^2(X) \to S^2(Y)$. But pullbacks and $q$-expansions are both compatible with base change. Therefore, it suffices to compute the induced map $S^2(X) \to S^2(Y)$ when the base field is $\C$. But we have already shown that there are choices of the $q_{ij}, q$ such that $\psimod^*(q_{ij}) = q^{A_{ij}}$. The claim follows.

  Finally, independence from $A$ follows from \cite[V.1.5]{faltings1990degeneration}.

  \hrule
  
  The coefficients $c_Q$ depend only on the point $y_0 \in \overline{\ag} - \ag$ where we compute the $q$-expansion of $f$, and on the chosen basis $q_{ij}$ for $S^2(X)$
. The $q_{ij}$ may be viewed as local affine functions on $\overline{\ag}$---see IV.2.6 and Section IV.3 of~\cite{faltings1990degeneration}. Thus $y_0$ is characterized by $q_{ij}(y_0) = 0$ for all $i,j$. But the $q_{ij}$ are chosen independently of $A$ over $\C$, and so by functoriality the neighborhood $\Spec R[q_{ij}] \subset \overline{\ag}$ is independent of $A$. In particular, we have $\psi_A(\infty) = y_0$ for all $A$, and the claim follows. 

% By choosing bases for $S^2(X)$ compatibly for all $A$, we can thus guarantee that the $c_Q$ are independent of $A$. 
  % Set $q_{ji} = q_{ij}$. As in \cite[Section V.1]{faltings1990degeneration}, a $q$-expansion for $f$ is of the form
  % \[
  %   \sum_{Q \in D} c_Q \prod q_{ij}^{Q_{ij}}.
  % \]
 % where $Q$ ranges over $g \times g$ symmetric, half-integral, positive semidefinite matrices.
  % The morphism $\psimod$ induces a morphism $X_0(N) \to \overline{\ag}$ on the toroidal compactifications. We consider $\psimod$ in a formal neighborhood of the $I_1$ cusp of $X_0(N)$.
  % Here, $\Delta: \G_m \to \G_m^g$ is the diagonal map, and $\lambda_A: \G_m^g \to \G_m^g$ is the natural map induced by $A$.
  % Let $E$ be the split torus with character group $S^2(Y)$ and $F$ the split torus with character group $S^2(X)$; see~\cite[IV.2.6]{faltings1990degeneration}. These split tori are essentially parameter spaces for the periods, so $E$ is analogous to the upper half-plane $\hh$ and $F$ to the Siegel upper half-space $\hh_g$. Then $\psimod$ induces a map $E \to F$ characterized by the property that the pullback of $q_{ij}$ is $q^{A_{ij}}$. Since $q$-expansions are compatible with pullbacks, the $q$-expansion of $\psimod^*(f)$ is
  % \begin{align*}
  %   \sum_{Q \in D} c_Q \prod q^{A_{ij}Q_{ij}} &= \sum_{Q \in D} c_Q q^{\sum A_{ij}Q_{ij}} \\
  %   &= \sum_{Q \in D} c_Q q^{\tr(AQ)}.
  % \end{align*}
\end{proof}

\begin{proof}[Proof of Theorem~\ref{thm:curves-dense}]
  Let $R$ denote the base ring. We claim that $\cup X_A$ is Zariski dense in $\ag$. The claim is trivial when $g = 1$, so we assume $g \geq 2$. It suffices to show that for all non-zero Siegel modular functions $f: \ag \to R$, there exists $A \in \detl$ such that the pullback $\psimod^*(f)$ is non-zero.

  Let $f$ be a Siegel modular function on $\ag$, viewed as a global section of the structure sheaf. Then by Lemma~\ref{lemma:q-expansion}, there exist coefficients $c_Q \in R$ for $Q \in D$, such that for all $A \in \detl$, $\psimod^*(f)$ admits a $q$-expansion $\sum_{Q \in D} c_Q q^{\tr(AQ)}$.
  %where $Q$ ranges over thet set $\mathfrak{Q}$ of all symmetric half-integral positive semi-definite matrices. % \cite[Prop. V.1.5]{faltings1990degeneration}.

  Let $S = \{ Q \in D :c_Q \neq 0\}$. By Lemma~\ref{lem:unique-minimizer} applied to the set $S$, there is an open cone $C$ of $g \times g$ real, symmetric, positive definite matrices $A$ such that $\tr(AQ)$ is minimized by a unique $Q \in S$.

  By Lemma~\ref{lem:rggt-dense}, there exists an element of $C$ of the form $rGG^t$ with $r \in \R^+$ and $G \in \Sl_g(\Z[1/\ell])$. Since $C$ is a cone, we may scale this element to obtain a matrix $A \in \detl \cap C$.

  Let $n = \min \{\tr(AQ) \colon Q \in S\}$. By definition of $C$, there is a unique $Q_0 \in S$ such that $\tr(AQ_0) = n$. % If $k = \C$, one has that the $q$-expansion of $f \circ \psimod$ is $\sum_Q c_Q q^{\tr(AQ)}$. By functoriality, this holds when $k$ is an arbitrary algebraically closed field.
  % Since $q$-expansions interact
  % with modular morphisms in a natural way, %as expected,
  % the $q$-expansion of $\psimod^*(f)$ is $\sum_Q c_Q q^{\tr(AQ)}$.
  Thus, the coefficient of $q^n$ in the $q$-expansion of $\psimod^*(f)$ is $c_{Q_0}$. Since $Q_0 \in S$, $c_{Q_0} \ne 0$. Hence $\psimod^*(f) \neq 0$, as desired.
\end{proof}







\bibliographystyle{halpha}
\bibliography{./references}

\end{document}
