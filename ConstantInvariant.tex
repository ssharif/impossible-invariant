\documentclass{amsart}
\usepackage{amsmath, amsthm, amssymb,latexsym,enumerate,mathrsfs}
\usepackage[all]{xy}
\usepackage{enumitem}
\usepackage{hyperref}
\usepackage{invariant}
\usepackage{xcolor}
\usepackage{tikz-cd}
\usepackage{verbatim}
\usepackage{lineno}
\linenumbers

\title[Algebraic maps constant on unpolarized isomorphism classes]{Algebraic maps constant on isomorphism classes of unpolarized abelian varieties are constant}

\author[E.\ Rains]{E.\ Rains}
\address{}
\email{}
\author[K.\ Rubin]{K.\ Rubin}
\address{}
\email{}
\author[T.\ Scholl]{T.\ Scholl}
\address{}
\email{}
\author[S.\ Sharif]{S.\ Sharif}
\address{}
\email{}
\author[A.\ Silverberg]{A.\ Silverberg}
\address{Department of Mathematics, University of California, Irvine, CA 92697, USA}
\email{asilverb@uci.edu}
%\subjclass[2010]{??}
\keywords{abelian varieties, polarizations}
\thanks{Support for the research was provided by the Alfred P.~Sloan Foundation
and the National Science Foundation.}

\begin{document}

\begin{abstract}
?
\end{abstract}


\today
\maketitle

%\tableofcontents


\section{Introduction}
\label{sec:introduction}

If $A$ and $B$ are abelian varieties, we say $A$ and $B$ are \emph{weakly isomorphic}, written $A \approx B$, if $A$ and $B$ are isomorphic as unpolarized abelian varieties. Let $\ag$ denote the moduli space of principally polarized abelian varieties of dimension $g$. Our main result is the following.
\begin{theorem}\label{thm:invariant-c-constant}
  Suppose that $g\in\Z_{\ge 2}$, $R$ is a domain, and $f: \ag \to X$ is a morphism of $R$-schemes. Suppose $f(A) = f(B)$ whenever $A \approx B$. Then $f$ is a constant function.
\end{theorem}

It suffices to prove Theorem \ref{thm:invariant-c-constant} when $R$ is an algebraically closed field, since a scheme over an algebraically closed field $k$ is also a scheme over every subring of $k$.


% Let $R$ be a scheme, and for an $R$-scheme $S$ write $S[R]$\textcolor{red}{TODO: is this necessary?} to be the set
% \[
%   \dlim_{T/R} S(T)
% \]
% where the limit is over all $R$-schemes $T$. Let
% \[
%   \sg: \rschemes \to \mathcal{P}((\ag \times \ag)[R])
% \]
% be the functor from $R$-schemes to the power set of $(\ag \times \ag)[R]$ that sends an $R$-scheme $T$ to the set
% \[
%   \sg(T) = \{(A,B) \in (\ag \times \ag)(T) | A \approx B\}.
% \]


If $R$ is a scheme, let
$$
\sg(R) = \{(A,B) \in (\ag \times \ag)(R) | A \approx B\}.
$$
We will deduce Theorem \ref{thm:invariant-c-constant} from the following result.

\begin{theorem}\label{thm:sg-c-dense}
  If $g\in\Z_{\ge 2}$, $R$ is a domain, $k$ is an algebraically closed field, and $R \subseteq k$, then the set $\sg(R)$ is Zariski dense in the $R$-scheme $\ag \times \ag$.
\end{theorem}

%In arbitrary characteristic we have the following, which w
We will prove the following result in Section~\ref{sec:characteristic-p}.
\begin{theorem}\label{thm:arbit-char}
  Suppose that $g\in\Z_{\ge 2}$, $R$ is a scheme, and $f: \ao^g \to X$ is a morphism of $R$-schemes. Suppose $f(A) = f(B)$ whenever $A \approx B$. Then $f$ is a constant function.
\end{theorem}

Our motivation behind Theorem \ref{thm:sg-c-dense} is the proposal for a construction of a cryptographic protocol in~\cite{multiparty}. In that protocol, $n$ parties each construct a product of elliptic curves over a finite field such that any pair of products is isomorphic. Put another way, each party computes a point of $\ao^g$ so that the chosen points are weakly isomorphic to each other. However, the proposal for a protocol was incomplete. The open question in~\cite{multiparty} was whether one can extract a numerical invariant of the product of elliptic curves that respects weak isomorphism, that is, a non-constant map $f: \ao^g \to X$ for a suitable space $X$ such that $f(A) = f(B)$ whenever $A \approx B$. In this context, Theorem~\ref{thm:arbit-char} shows that if $f$ is algebraic, then it is constant, and thus not useful cryptographically. There may be useful non-algebraic invariants. %; indeed, \cite[Section 5]{multiparty} considered an invariant due to Deligne, but unfortunately finds it flawed as well.

%\subsection{Overview}

\begin{definition}\label{def:detl}
If $\ell$ is a prime number and $g$ is a positive integer, let $\detl$ denote the set of positive definite symmetric $g \times g$ integer matrices whose determinant is a power of $\ell$.
\end{definition}

If $N$ is a positive integer, let $Y_0(N)$ denote the modular curve parametrizing pairs $(E, C)$, where $E$ is an elliptic curve and $C \subset E$ is a cyclic subgroup of $E$ of order $N$. For every $A \in \detl$, define a map $\psimod: Y_0(\det(A)) \to \ag$ as follows. If $(E, C) \in Y_0(N)$, the matrix $A$ induces a natural endomorphism $\lambda_A$ of $E^g$. Since $A$ is symmetric and positive definite, we can view $\lambda_A$ as a polarization on $E^g$. Let $B = E^g/((\ker \lambda_A) \cap C^g)$, let $\pi: E^g \to B$ be the quotient map, and let $\lambda$ denote the (unique) principal polarization on $B$ such that $\pi^*(\lambda) = \lambda_A$. Define $\psimod$ by sending $(E,C) \in Y_0(N)$ to the abelian variety $B$ with principal polarization $\lambda$, and let $X_A$ denote the image of $\psimod$.

\begin{theorem}\label{thm:curves-dense}
  The set $\bigcup_{A \in \detl} X_A$ is Zariski dense in $\ag$.
\end{theorem}

\begin{theorem}\label{thm:Sg-dense}
  Suppose $g\in\Z_{\ge 2}$, $\ell$ is a prime number, and $k$ is an algebraically closed field. If $A,A' \in \detl$, then $\sg(k) \cap (X_A \times X_{A'})$ is Zariski dense in $X_A \times X_{A'}$.
\end{theorem}

Theorems \ref{thm:curves-dense} and \ref{thm:Sg-dense} are proved in sections \ref{sec:step-1} and \ref{sec:step-2}, respectively. With these two results, the proofs of our main theorems follow easily.

\begin{proof}[Proof of Theorem~\ref{thm:sg-c-dense}]
%  If $X$ and $Y$ are subsets of $\ag \times \ag$, we write (I suggest omitting this notation and writing it out in words, rather than proving the result in a long expression) $X \prec Y$ if $X \subseteq Y$ and $X$ is Zariski dense in $Y$. Then
Let $k$ be an algebraically closed field containing $R$. We have
$$
\bigcup_{A,A'} \left(\sg(k) \cap (X_A \times X_{A'})\right) =  \sg(k) \cap \left(\bigcup_{A,A'} X_A \times X_{A'}\right)
   \subset \sg(k).
   $$
By Theorem~\ref{thm:sg-c-dense},
$\sg(k) \cap (X_A \times X_{A'})$ is Zariski dense in $X_A \times X_{A'} =
    \left(\bigcup_{A} X_A\right) \times \left(\bigcup_{A'} X_{A'}\right),$ which by Theorem~\ref{thm:Sg-dense} is Zariski dense in $\ag \times \ag$.
%  \begin{align*}
%    \sg(\C)
%    &\supseteq
%    \sg(\C) \cap \left(\bigcup_{A,A'} X_A \times X_{A'}\right)
%    \\
%    &=
%    \bigcup_{A,A'} \sg(\C) \cap (X_A \times X_{A'})
%    \\
%    &\prec
%    \bigcup_{A,A'} X_{A} \times X_{A'}
%    &&\text{By Theorem~\ref{thm:sg-c-dense}}
%    \\
%    &=
%    \left(\bigcup_{A} X_A\right) \times \left(\bigcup_{A'} X_{A'}\right)
%    \\
%    &\prec
%    \ag \times \ag
%    &&\text{By Theorem~\ref{thm:Sg-dense}}.
%  \end{align*}
\end{proof}


\begin{proof}[Proof of Theorem~\ref{thm:invariant-c-constant}]
  Suppose $f: \ag \to X$ is a morphism of $R$-schemes. Let $k$ be an algebraically closed field containing $R$. Consider the fiber product $\df = \ag \times_X \ag$.
  % determined by the diagram
  % \[
  % \begin{tikzcd}
  %   \df \arrow[r] \arrow[d] & \ag \arrow[d,"f"]
  %   \\
  %   \ag \arrow[r,"f"] & X.
  % \end{tikzcd}
  % \]
%  The hypotheses on $f$  imply that
Since $f$ is a morphism such that $f(A) = f(B)$ whenever $A \approx B$, we have that $\sg(k) \subset \df(k)$.
  % https://ncatlab.org/nlab/show/separated+morphism+of+schemes
   Since $\df$ is a closed subscheme of $\ag \times \ag$, Theorem~\ref{thm:sg-c-dense} implies that $\df = \ag \times \ag$, giving the desired result.
\end{proof}



\section{The curves $X_{A}$}
\label{sec:curves-on-Ag}

(This section should be shortened, if possible.)

Fix a positive integer $g$, and a $g \times g$ symmetric, positive definite integer matrix $A$ whose determinant $N$ is not divisible by the characteristic of our base. %(Later we will take $N$ to be a power of a prime $\ell$.)
Recall the map
\[
\psimod: Y_0(N) \to \ag, \quad (E,C) \mapsto (B,\lambda)
\]
defined in the introduction.


%\textcolor{red}{TODO: what constraints are required for $n$?}. In this section we will construct the curves $X_A \subset \ag$. % mentioned in Section~\ref{sec:introduction}.

%We will define the maps $Y_0(\ell^n) \to \ag$ in two ways: geometrically based on the moduli interpretation, and complex analytically. We will use that these two interpretations are the same in the proof of Theorem~\ref{thm:sg-c-dense}. We will apply the moduli interpretation to prove Theorem~\ref{thm:Sg-dense}, and the complex analytic version to prove Theorem~\ref{thm:curves-dense}. Since the latter result does not directly carry over to positive characteristic, we will use a variant that shows density in $\ao^g$; see \ref{sec:characteristic-p}.

For another construction of these maps, see \cite[p. 19 et seq.]{rains}.

\begin{definition}
If $M \in \Gl_g(\Z)$ and $E$ is an elliptic curve, let $\rho_M$ denote the natural endomorphism of $E^g$ induced by $M$.
\end{definition}

\subsection{Geometric description}
\label{sec:geo-desc}


%Suppose $(E, C) \in Y_0(N)$, i.e., $E$ is an elliptic curve and $C \subset E$ is a cyclic subgroup of $E$ of order $N$.  The matrix $A$ induces a natural endomorphism $\lambda_A$ of $E^g$. Since $A$ is symmetric and positive definite, by identifying $E^g$ with its dual we can view $\lambda_A$ as a polarization on $E^g$ of degree $N^2$.
If $(E, C) \in Y_0(N)$, let
$$
K(A) = (\ker \rho_A) \cap C^g  \subset E^g.
$$

%Where is the next result used? If we use it, we should refer to it. If we don't use it, let's comment it out, for now.
%\begin{lemma}
%  The subgroup $K(A)$ is a maximal isotropic subgroup of $\ker \lambda_A$.
%\end{lemma}
%
%\begin{proof}
%  Let $P$ be a generator of $C$, defined over the algebraic closure of our base field. Identify $C^g$ with $(\Z/N)^g$ via the map $(a_iP) \mapsto (a_i)$. Then multiplication by the matrix $A$ induces a map $\lambda_A^{(C)}:C^g \to C^g$. One sees (how??) that $\#(\ker \lambda_A^{(C)}) = \sqrt{\#(\ker \lambda_A})$. Further, $\ker \lambda_A^{(C)} \subset C^g$ is isotropic (why?). The claim follows.
%\end{proof}

%Let $B = E^g/K(A)$, and let $\pi: E^g \to B$ be the quotient map. Then by \cite[Prop. 16.8]{milne-av}, there is a principal polarization $\lambda$ on $B$ for which $\pi^*(\lambda) = \lambda_A$. If $X$ is an abelian variety, let $NS(X)$ denote its N\'eron-Severi group. Since $\pi^*: NS(B) \to NS(E^g)$ is injective, $\lambda$ is unique.

%\begin{definition}\label{def:psimod-def}
%Define
%\[
%\psimod: Y_0(N) \to \ag, \quad (E,C) \mapsto (B,\lambda).
%\]
%\end{definition}

(State here where we'll use the next result.)
\begin{lemma}\label{lem:psimod-weakly-isomorphic-to-product}
  Let $d_1, \cdots, d_g$ be the elementary divisors of $A$, and for $(E,C) \in Y_0(N)$ and $1 \le i \le g$, let $E_i = E/d_i^{-1}NC$. If $(B,\lambda) = \psimod(E,C)$, then
$
    B \approx E_1 \times \cdots \times E_g.
$
\end{lemma}

\begin{proof}
  Let $D$ be the diagonal matrix with $d_1, \cdots, d_g$ on the diagonal.
%   \[
%     D =
%    \begin{bmatrix}
%      {d_1} & & & \\
%      & {d_2} & & \\
%      & & \ddots & \\
%      & & & {d_{g}}
%    \end{bmatrix}
%  \]
Then $D$ is the Smith normal form of $A$, and there exist $U,V \in \Gl_g(\Z)$ such that $A = UDV$. Then $\rho_U$ and $\rho_V$ are automorphisms of $E^g$ induced by $U$ and $V$, respectively, and $\rho_A = \rho_U \rho_D \rho_V$. Since
  \begin{align*}
    \ker \rho_D &= E[d_1] \times E[d_2] \times \cdots \times E[d_g]
  \end{align*}
  we have $(\ker \rho_D) \cap C^g = \prod_{i=1}^g d_i^{-1}NC$. %d_1^{-1}NC \times \cdots \times d_g^{-1}NC$.
 Since $\rho_V(C^g) = C^g$, we now have
  \[
    \rho_V((\ker \rho_A) \cap C^g) = (\ker \rho_D) \cap C^g.
  \]
  Thus the quotients of $E^g$ by $(\ker \rho_A) \cap C^g$ and by $(\ker \rho_D) \cap C^g$ are weakly isomorphic. The lemma follows.
\end{proof}

\subsection{Analytic description}
\label{sec:ana-desc}

In this section we assume that the base scheme is $\C$.
%Suppose that $A$ is a symmetric, positive definite integer matrix. Let $N = \det A$.
Let $\hh$ denote the complex upper half plane and let $\hh_g$ denote the degree $g$ Siegel upper half space. Recall that $\Sp_{2g}(\Z)$ (resp., $\Gamma_0(N)$) acts on $\hh_g$ (resp., $\hh$) by fractional linear transformations,
 $Y_0(N) = \hh/\Gamma_0(N)$, and $\ag = \hh_g/\Sp_{2g}(\Z)$.

\begin{lemma}\label{lem:psi-A-n}
The map \[
  \psi_A: \hh \to \hh_g, \quad  \tau \mapsto \tau A
\]
induces a map %descends to a morphism
$
  \psimodt: Y_0(N) \longrightarrow \ag.
$
\end{lemma}

\begin{proof}
Let
\[
\sigma = \begin{bmatrix} a & b \\ c & d \end{bmatrix} \in \Gamma_0(N) \text{ and } M = \begin{bmatrix} aI_g & bA \\ cA^{-1} & dI_g \end{bmatrix}
\]
where $I_g$ denotes the $g \times g$ identity matrix.
If $\tau \in \hh$, a direct computation shows that $M \in\Sp_{2g}(\Z)$
% it is integral because \det(A) | c, so cA^{-1} is integral.
% M is in Sp because then M^t*\Omega*M = M
% where \Omega = \begin{matrix} 0 & I \\ -I & 0 \end{matrix}
and  $\sigma(\tau)A = M(\tau A)$.
%(It's well-defined. Why is it a morphism?)
\end{proof}


%In fact, $\psimodt$ is none other than $\psimod$, from which one can obtain an alternative proof of Lemma \ref{lem:psi-A-n}.
\begin{lemma}
  When the base scheme is $\C$, we have $\psimodt = \psimod$.
\end{lemma}

\begin{proof}
  Suppose $(E, C) \in Y_0(N)$. There exists $\tau \in \hh$ such that $E = \C/(\Z + \tau \Z)$ and $C = \langle 1/N \rangle$. We first show that $\psimodt(E,C) \approx \psimod(E,C)$.

  Let $\Lambda = \Z^g + \tau \Z^g \subset \C^g$. Then $\C^g/\Lambda = E^g$, where projection on the $i$th complex coordinate is the same as projection onto the $i$th factor of $E^g$. Let
  \[
    \tla = \Z^g + \tau A \Z^g \quad \text{ and } \quad     \Lambda_A = A^{-1}\Z^g + \tau \Z^g.
  \]
By definition, $\psimodt(\tau) \approx \C^g/\tla$.
%  \[
%    \Lambda_A = A^{-1}\Z^g + \tau \Z^g.
%  \]
%  Multiplication by $A^{-1}: \C^g \to \C^g$ induces an isomorphism
%  \[
 %   \C^g/\tla \xrightarrow{\sim} \C^g/\Lambda_A.
 % \]
 Since $\Lambda \subset \Lambda_A$, there is a natural isogeny
  \[
    \rho: E^g = \C^g/\Lambda \to \C^g/\Lambda_A.
  \]
  We wish to compute $\ker \rho$.

  Multiplication by $A: \C^g \to \C^g$ induces an isomorphism
  \[
     \C^g/\Lambda_A \xrightarrow{\sim}  \C^g/\tla
  \]
and an isogeny
  \[
    \rho_A: \C^g/\Lambda \longrightarrow \C^g/\Lambda,
  \]
  %This is the same isogeny $\rho_A$ as in the proof of Lemma \ref{lem:psimod-weakly-isomorphic-to-product}; i.e., it
  where $\rho_A$ as before is the natural isogeny $E^g \to E^g$ induced by the matrix $A$. Then
\[
\ker \rho_A = A^{-1}\Z^g + \tau A^{-1} \Z^g \pmod{\Lambda}.
\]
%With our identification $E = \C/(\Z + \tau\Z)$, recall that the distinguished subgroup $C \subset E$ is $\langle 1/N \rangle$. Then $C^g \subset E^g$ is $\frac{1}{N}\Z^g \pmod{\Lambda}$. It follows that
Then
\[
\ker \rho = (\ker \rho_A) \cap C^g = (\ker \lambda_A) \cap C^g = K(A).
\]
Since $\psimod(E,C) \approx E^g/K(A)$, we have proven that $\psimod(E,C) \approx \psimodt(E,C)$.

  A polarization on a $g$-dimensional complex abelian variety is given by an alternating Riemann form $E: \C^g \times \C^g \to \R$.

  For a point $\Omega \in \hh_g$, the corresponding abelian variety is
\[
\C^g/(\Z^g + \Omega \Z^g),
\]
and the corresponding alternating Riemann form is the unique such form $E$ satisfying, for $u,v \in \Z^g$, $E(u,\Omega v) = u^tv$. We call this form the \emph{Siegel alternating form} arising from $\Omega \in \hh_g$; this form specifies the principal polarization for the class of $\Omega$ in $\ag$. %For example, if $\Omega = \tau I$ for $\tau \in \hh$, so that the abelian variety is $E^g$, then the Siegel alternating form represents the product principal polarization.

Now consider the (nonprincipal) polarization $\rho_A$ on $E^g$. The corresponding alternating Riemann form is given by $E_A(u,\tau v) = u^tAv$, where $u,v \in \Z^g$. Since $E_A(\Lambda_A \times \Lambda_A) \subset \Z$, it follows that $E_A$ is a Riemann form for $\C^g/\Lambda_A$ as well. Write $\lambda$ for the polarization of $\C^g/\Lambda_A$ given by $E_A$. Recall that the polarization coming from $\psimod$ is the unique one descending from the product polarization on $E^g$. Since $\lambda$ also descends from the product polarization, we have
\[
  \psimod(E,C) = (\C^g/\Lambda_A, \lambda).
\]
Let $\tilde{\lambda}$ be the polarization coming from the Siegel alternating form for $\tau A$; that is, given by the form $E_{\tau A}(u, \tau A v) = u^tv$. If $u, v \in \Z^g$, we have
\begin{align*}
  E_{\tau A} (u, \tau A v) &= u^tv \\
                          &= E_A(A^{-1}u, \tau v) \\
                          &= E_{A}(A^{-1}u, A^{-1}\tau Av).
\end{align*}
Thus multiplication by $A$ on $\C^g$ induces an isomorphism of polarized abelian varieties
\[
  \psimod(E,C) = (\C^g/\Lambda_A, \lambda) \xrightarrow{\sim} (\C^g/\tla, \tilde{\lambda}) = \psimodt(E,C),
\]
%Since $\psimodt(E,C) = (\C^g/\tla, \tilde{\lambda})$,
as desired.


 % Further, this polarization is specified by letting the columns be a symplectic basis for the associated Riemann form $H: \C^g \times \C^g \to \C$; this is precisely the product polarization.

 %  The abelian variety $B$ associated to $\psi_A(\tau)$ is $\C^g/\tilde{\Lambda}$, where $\tilde{\Lambda}$ is the lattice generated by the columns of
 %  \[
 %    \begin{bmatrix}
 %      I | \tau A
 %    \end{bmatrix},
 %  \]
 %  and with the associated principal polarization.
\end{proof}
% Write $\Omega$ for $\tau I$, where $I$ is the $g \times g$ identity matrix. The period matrix for $\psi_{I,n}(\tau)$ is
% \[
%   M = \begin{bmatrix}
%     I | \Omega
%   \end{bmatrix}.
% \]
% Observe that if $E$ is the elliptic curve corresponding to $\tau \in \hh$, then the abelian variety corresponding to $\psi_{I,n}(\tau) \in \hh_g$ is $E^g$ with the product polarization.

% Given a period matrix $M$, let $\Lambda(M)$ be the lattice generated by the columns of $M$, so that the corresponding abelian variety is $A(M) := \C^g/\Lambda(M)$. We say two period matrices $M, M'$ are \emph{equivalent} if $\C^g/\Lambda(M)$ is isomorphic to $\C^g/\Lambda(M')$, and similarly the matrices are \emph{weakly equivalent} if the abelian varieties are weakly isomorphic. Let $D$ be the Smith normal form of $A$, so that there are $U,V \in \Gl_g(\Z)$ for which $A = UDV$. Then the period matrix for $\Psi_{A,n}(\tau)$ is
% \[
%   \begin{bmatrix}
%     I | \Omega A
%   \end{bmatrix},
% \]
% which is equivalent to
% \[
%   \begin{bmatrix}
%     D^{-1}U^{-1} | V
%   \end{bmatrix}
% \]
% and hence weakly equivalent to
% \[
% M' = \begin{bmatrix}
%     D^{-1}U^{-1} | \Omega
%   \end{bmatrix}.
% \]
% Let $M''$ be the period matrix\[
%   \begin{bmatrix}
%     D^{-1} | \Omega
%   \end{bmatrix}.
% \]
% The matrix $D^{-1}$ is a diagonal matrix whose diagonal entries are powers of $1/\ell$. Suppose the $i$th diagonal entry is $1/\ell^{n_i}$, and set
% \[
%   \vec{n} = (n_1, \ldots, n_g).
% \]
% One sees that $A(M'') = \psivec(\tau)$, where $\lambda$ is the product polarization. In particular, if $P \in E$ generates the distinguished $\ell^n$-torsion subgroup, then
% \[
%   A(M'') = E/\langle \ell^{n-n_1} P \rangle \times \cdots \times E/\langle \ell^{n-n_g} P \rangle.
% \]
% The abelian variety $A(M')$ is similary a quotient of $E^g$ by an $\ell$-power subgroup. But the natural map $U: E^g \to E^g$ sends one kernel subgroup to another, and thus induces a (weak) isomorphism $A(M') \to A(M'')$. As $A(M'') = \psivec(\tau)$ and $A(M')$ is weakly isomorphic to $A(M) = \psimat(\tau)$, we conclude that
% \[
% \psimat(\tau) \textrm{ and } \psivec(\tau)
% \]
% are weakly isomorphic.



\section{Proof of Theorem~\ref{thm:curves-dense}}
\label{sec:step-1}

%The main goal of this section is to prove Theorem~\ref{thm:curves-dense}.

\begin{lemma}\label{lemma:sl-z-1overl-dense-sl-r}
  The set $\Sl_g(\Z[1/\ell])$ is dense in $\Sl_g(\R)$ with respect to the Euclidean topology.
  %Here, the topology is the one induced by the Euclidean metric on the entries.
\end{lemma}

\begin{proof}
  Let $G \in \Sl_g(\R)$. Factor $G$ as a product of elementary matrices
  \[
    G = E_n \cdots E_2 E_1
  \]
  where $\det E_i = \pm 1$. For each $E_i$, the entries, with at most one exception, are $0$ or $\pm 1$. Thus we can find a $g \times g$ matrix $E_i'$ with entries in $\Z[1/\ell]$ and $\det E_i' = \det E_i$ which is arbitrarily close to $E_i$. Let $G' = E_n' \cdots E_1'$. Certainly $G' \in \Sl_g(\Z[1/\ell])$. Since matrix multiplication is continuous, $G'$ is close to $G$.
\end{proof}

% \begin{proof}[Alternative proof]
%   Let $G = [g_{ij}] \in \Sl_g(\R)$. Let $X = [x_{ij}]$ be a matrix of $g^2$ variables, and consider the determinant map $\det: \R[\{x_{ij}\}] \to \R$. Choose $r,s$ so that
%   \[
%     \frac{\partial \det}{\partial x_{rs}}(G) \neq 0.
%   \]
%   Since $\Z[1/\ell]$ is dense in $\R$, for $(i,j) \neq (r,s)$ we can find $a_{ij} \in \Z[1/\ell]$ which is arbitrarily close to $g_{ij}$. By our hypotheses on $(r,s)$, there exists $a_{rs} \in \R$ such that $\det [a_{ij}] = 1$. Clearly $a_{rs} \in \Z[1/\ell]$. The determinant is continuous, so $a_{rs}$ must also be close to $g_{rs}$.
% \end{proof}

% \begin{proof}
%   The group scheme $\Sl_g$ is a connected reductive group, and hence is unirational. (???cite) Since $\Z[1/\ell]$ is topologically dense in $\R$, the claim follows.

%   Details: unirational means there is a dominant rational map $f:\Pro^n \to \Sl_g$ for some $n$. Given $G \in \Sl_g(\R)$, there some $G' \in f(\Pro^n(\R))$ which is close to $G$. Let $P \in \Pro^n(\R)$ with $f(P) = G'$. Then
% \end{proof}

%\begin{definition}\label{def:detl}
%  For $\ell$ a prime, let $\detl$ be the set of $g \times g$ symmetric, positive definite integer matrices $A$ for which %$\det A$ is a power of $\ell$.
%\end{definition}

Recall the definition of $\detl$ in Definition \ref{def:detl}.

\begin{lemma}\label{lemma:ggt-spd-detl}
  If $G \in \Sl_g(\Z[1/\ell])$, then for all sufficiently large $n \in \N$,
  \[
    \ell^n GG^t \in \detl.
  \]
\end{lemma}

\begin{proof}
  If $n \in \N$, then $\ell^n GG^t$ is symmetric and positive definite, and its determinant is a power of $\ell$. Let $N$ be the maximum power of $\ell$ appearing in the denominators of the entries of $GG^t$. Then for $n \geq N$, $\ell^n GG^t$ is an integer matrix.
\end{proof}


\begin{definition}
  Let $\permat$ denote the set of $g \times g$ real, positive definite symmetric matrices  with determinant $1$.
\end{definition}

\begin{lemma}\label{lemma:ggt-periodmatrices}
  $\permat = \{GG^t | G \in \Sl_g(\R)\}$.
\end{lemma}

\begin{proof}
  Suppose $A \in \permat$. By the Spectral Theorem, there exist a real orthogonal matrix $O$ and a real diagonal matrix $D$ such that $A = ODO^t$. Let $d_1, d_2, \dots, d_n$ be the diagonal entries of $D$. Since $A$ is positive definite, $d_i > 0$ for all $i$. Further, $\prod d_i = \det A = 1$. Let
  \[
    G = O
    \begin{bmatrix}
      \sqrt{d_1} & & & \\
      & \sqrt{d_2} & & \\
      & & \ddots & \\
      & & & \sqrt{d_{g}}
    \end{bmatrix}.
\]
Then $A = GG^t$ and $G \in \Sl_g(\R)$.
\end{proof}

\begin{proposition}\label{prop:A-over-detA}
  Let $S = {\{A/(\det A)^{\frac{1}{g}} | A \in \detl\}}$. Then $S$ is dense in $\permat$ with respect to the Euclidean topology.
\end{proposition}

\begin{proof}
%Let
%  \[
%   S =  \{A/(\det A)^{\frac{1}{g}} | A \in \detl\}.
%  \]
   By Lemma~\ref{lemma:ggt-spd-detl}, we have
  \[
    \{A/(\det A)^{\frac{1}{g}} \colon A = \ell^n GG^t \in M_{g \times g}(\Z), n \in \N, G \in \Sl_g(\Z[1/\ell])\} \subset S.
  \]
  Since $\det (\ell^n GG^t) = \ell^n$, the left-hand set equals
  \[
    \{GG^t | G \in \Sl_g(\Z[1/\ell])\}.
  \]
  The proposition now follows from Lemmas~\ref{lemma:sl-z-1overl-dense-sl-r} and \ref{lemma:ggt-periodmatrices}.
\end{proof}

\begin{definition}
If $X$ is a subset of a complex manifold $M$, we say that $X$ is {\em holomorphically dense} in $M$ if every holomorphic function that vanishes on $X$ also vanishes on $M$.
\end{definition}

\begin{remark}
If $X$ is dense in $M$ with respect to the Euclidean topology then $X$ is holomorphically dense in $M$, and if $X$ is holomorphically dense in $M$ then $X$ is Zariski dense in $M$.
\end{remark}

Let $\R^+$ denote the set of positive real numbers.
\begin{lemma}\label{lemma:holomorphic-closure-irM}
  The set ${\{ irM | M \in \permat, r \in \R^+\}}$ is holomorphically dense in $\hh_g$.
\end{lemma}


\begin{proof}
  The set $H := \{ irM | M \in \permat, r \in \R^+\}$ is the subset of $\hh_g$ with real part $0$. Note that $H$ is a real manifold with $\dim_{\R} H = g(g+1)/2$. So by \cite[Ch.~4.8]{krantz2017harmonic}, it suffices to show that $H$ is a totally real. That is, it suffices to show that the tangent space \textcolor{red}{TODO: figure out correct property}

  As $H$ is a topological group (it is isomorphic to $\R^+ \times \detl$), it is enough to consider the tangent space at the identity $iI_g$. The exponential map goes from \textcolor{red}{TODO: finish}
\end{proof}

% \begin{lemma}
%   The holomorphic closure of ${\bigcup_{A \in \detl} \psi_A(i\R^+)}$ is $\hh_g$.
% \end{lemma}

% \begin{proof}
% \end{proof}

% \begin{lemma}
%   \[
%     \hclos{\bigcup_{A \in \detl} \im \psi_A} = \hh_g.
%   \]
% \end{lemma}

% \begin{proof}
%   Since $\psi_A(i\R^+) \subset \im \psi_A$, the claim follows from the previous lemma.
% \end{proof}


\begin{proof}[Proof of Theorem~\ref{thm:invariant-c-constant}]
  We have
  \begin{align*}
    \cup_A \psi_A(i\R^+) &= \cup \{irA | r \in \R^+, A \in \detl\} \\
               &= \cup \{irA/(\det A)^{\frac{1}{g}} | r \in \R^+, A \in \detl\},
  \end{align*}
  and this set is dense in
  \[
    \{irM | r \in \R^+, M \in \permat\}
  \]
with respect to the Euclidean topology,  by Proposition~\ref{prop:A-over-detA}.
  By Lemma~\ref{lemma:holomorphic-closure-irM}, the set $\cup_A \psi_A(i\R^+)$ is holomorphically dense (define this) in $\hh_g$. Thus $\cup_A \im \psi_A$ is holomorphically dense in $\hh_g$. Passing to the quotient, if we consider $\ag$ as a complex manifold, we have that $\cup_A \im \psimod$ is holomorphically dense in $\ag$.

  By definition of $\psimod$,  $\im \psimod \subset \ag$ is the image of $\im \psi_A \subset \hh_g$ under the canonical covering map $\hh_g \to \ag$. As we have shown, $\im \psi_A$ is holomorphically dense in $\hh_g$, and so the image of $\psimod$ in $\ag$ is holomorphically dense when viewing $\ag$ as a complex manifold. But holomorphically dense implies Zariski dense, and the claim follows.
\end{proof}



\section{Proof of Theorem~\ref{thm:Sg-dense}}
\label{sec:step-2}

%The main goal of this section is to prove Theorem~\ref{thm:Sg-dense}.

\textcolor{red}{TODO: introduce lemmas}

\begin{lemma}\label{lem:silly}
  Let $\ell$ be a prime. Then there is an imaginary quadratic field $K$ such that $\sO_K^\times = \{\pm 1\}$ and $\ell$ splits into principal primes in $K$.
\end{lemma}
\begin{proof}
  The fields $K$ in which $\ell$ splits into principal primes are precisely the fields generated by roots of the polynomials $x^2 - tx + \ell$ with $0 < |t| < 2\sqrt{\ell}$. There are $2\lfloor 2\sqrt{\ell} \rfloor$ such polynomials. Recall that there are, up to Galois conjugates, at most $4$ elements of norm $\ell$ in $\Q(i)$ and at most $6$ elements of norm $\ell$  in $\Q(\sqrt{-3})$. Thus, if $4\sqrt{\ell} > 10$, then there are more than $10$ such polynomials, so one must correspond to a field other than $\Q(i)$ and $\Q(\sqrt{-3})$. The remaining primes $\ell < 7$ can be checked by hand.
\end{proof}

\begin{lemma}\label{lem:K-exists}
  Suppose $\ell$ is a prime, $g$ is a positive integer, and $K$ is an imaginary quadratic field over which $\ell$ splits into principal primes, namely $\ell = \alpha\sO_K \cdot \overline{\alpha}\sO_K$ with $\alpha\in \sO_K$.
%  \begin{enumerate}
%    \item $\sO_K^\times = \{\pm 1\}$,
%    \item $\ell$ splits in $K$ into principal primes $\alpha\sO_K \cdot \overline{\alpha}\sO_K$ with $\alpha\in \sO_K$,
%    \item
Then there are infinitely many rational primes $q$ such that
    \begin{enumerate}
      \item $q$ is inert in $K$,
      \item $q \equiv -1 \mod{g}$, and
      \item $\alpha \mod q\sO_K \in (\sO_K/q\sO_K)^\times$ is a $g$th power.
    \end{enumerate}
%  \end{enumerate}
\end{lemma}
\begin{proof}
  %By Lemma~\ref{lem:silly}, we can find a $K$ satisfying (1) and (2).
  Let $L = K(\zeta_g,\alpha^{1/g},\overline{\alpha}^{1/g})$.
  Let $\sigma$ be any complex conjugation in $\Gal(L/\Q)$.
  Let $\frak{q}$ be any prime of $L$ unramified in $L/\Q$ whose Frobenius $\mathrm{Frob}(\frak{q}) \in \Gal(L/\Q)$ is $\sigma$. The Chebotarev density theorem guarantees that there are infinitely many such $\frak{q}$.
  Let $q$ be the rational prime below $\frak{q}$.
  Since $\sigma|_K$ is complex conjugation, $q$ is inert in $K$, giving (1).
  Since $\sigma|_{\Q(\zeta_g)}$ is complex conjugation, $q \equiv -1 \mod{g}$, giving (2).
%To see this, note that under the usual isomorphism $\Gal(\Q(\zeta_g)/\Q) \cong (\Z/g\Z)^\times$, complex conjugation is associated to $-1$. The map Frobenius element corresponding to $\frak{q} \cap \Q(\zeta_g)$ sends $\zeta_g \mapsto \zeta_g^c$.
Since $\sigma$ has order $2$, we have $\sO_L/\frak{q} \cong \sO_K/q\sO_K \cong \F_{q^2}$. In particular, $\alpha^{1/g}$ is a $g$th root of $\alpha$ in $(\sO_K/q\sO_K)^\times$, giving (3).
%Moreover, if $\sigma$ satisfies these conditions, then so does any conjugate of $\sigma$.
%By Chebotarev's density theorem, it remains to show that there exists some $\sigma \in \Gal(L/\Q)$ of order $2$ that restricts to complex conjugation in $K$ and $\Q(\zeta_g)$. Every complex conjugation in $\Gal(L/\Q)$ has these properties.
%  Choose any embedding $\iota: L \to \C$ and define $\sigma \in \Gal(L/\Q)$ by $a \mapsto \iota^{-1}(\overline{\iota(a)})$. Note that $\sigma$ has order $2$. Since $K$ and $\Q(\zeta_g)$ are CM fields, $\sigma$ restricts to the usual complex conjugation on them. Therefore $\sigma$ has the desired properties.
\end{proof}

\textcolor{red}{TODO: introduce lemmas}

\begin{definition}
  Suppose that $K$ is an imaginary quadratic field. If $q$ is a prime number that is inert in $K$, let
  $$\Gt_q=(\sO_K/q\sO_K)^\times/(\Z/q\Z)^\times. $$
  %The field $K$ should be clear from the context.
\end{definition}

\begin{lemma}\label{lem:c-torsor}
  Suppose $E$ is an elliptic curve over an algebraically closed field $k$, and $\End(E) \cong \sO_K$ for some imaginary quadratic field $K$. Let $q$ be a prime inert in $K$ and not equal to the characteristic of $k$. Then the set of subgroups of $E$ of order $q$ is a $\Gt_q$ torsor.
\end{lemma}
\begin{proof}
  Since $E[q]$ is a module over $\sO_K/q\sO_K \cong \F_{q^2}$  of size $q^2$, we have that $E[q] \cong \F_{q^2}$ as $\F_{q^2}$-vector spaces. So $(\F_{q^2})^\times/(\F_q^\times) \cong \Gt_q$ acts freely and transitively on the one-dimensional $\F_q$-subspaces of $E[q]$.
\end{proof}

\begin{definition}[{\cite[Sec.~2]{kani2011products}}]\label{def:ker-idl}
  Let $A$ be an abelian variety over a field $K$. Given a regular left-ideal $I$ of $\End A$, let $H(I) = \cap_{\phi \in I}\ker \phi$. A finite subgroup scheme $H$ is a \emph{ideal subgroup} if $H = H(I)$ for some $I$. Symmetrically, given such an $H$, let $I(H) = \{\phi \in \End A \colon \phi(H) = 0\}$. We say $I$ is a \emph{kernel ideal} if it is the form $I(H)$ for some $H$.
\end{definition}

\begin{theorem}[{\cite[Thm.~20b]{kani2011products}}]\label{thm:kani-20b}
  Let $E$ be a CM elliptic curve over an algebraically closed field, and $H$ a finite subgroup scheme of $E$. Then $H$ is a kernel subgroup if and only if there is an inclusion $\End E \hookrightarrow \End E/H$. Moreover, if $H_1,H_2$ are ideal subgroups of $E$, then $E/H_1 \approx E/H_2$ if and only if $I(H_1)$ is isomorphic to $I(H_2)$ as $\End(E)$ modules.
  %$f_{E_H} \mid f_E$
\end{theorem}

\begin{lemma}\label{lem:c-end}
  Suppose $E$ is an elliptic curve over an algebraically closed field, and $\End(E) \cong \sO_K$ for some imaginary quadratic field $K$. Let $q$ be a product of distinct primes not equal to the characteristic of the base field and inert in $K$. If $\sC$ is a subgroup of $E$ of order $q$, then $\End(E/\sC) \cong \Z + q\sO_K$. In particular, every endomorphism of $E/\sC$ is induced by an endomorphism of $E$ that takes $\sC$ to $\sC$.
\end{lemma}
\begin{proof}
  Factor $q = \prod_{i=1}^n q_i$, where each $q_i$ is a prime inert in $K$ and not equal to the characteristic of the base field. We can write $\sC = \sum_{i=1}^n \sC_i$ where each $\sC_i$ is a subgroup of order $q_i$.

  The isogeny $\pi: E \to E/\sC$ factors into a chain of isogenies
  \[
    E
    \xrightarrow{\pi_1}
    E/\sC_1
    \xrightarrow{\pi_2}
    E/(\sC_1 + \sC_2)
    \xrightarrow{\pi_3}
    \cdots
    \xrightarrow{\pi_n}
    E/\sum_{i=1}^n\sC_i.
  \]
  Let $E_j = E/\sum_{i=1}^j\sC_i$ so $\pi_j: E_{j-1} \to E_j$. Define $\sO_j$ to be the order $\End(E_j)$ in $K$, and let $f_j$ be the conductor of $\sO_j$. Since $\pi_j$ has degree $q_j$, we have $[\sO_j : \sO_{j-1}] = q_j$, $[\sO_{j-1} : \sO_j] = q_j$, or $\sO_{j-1} = \sO_j$ \cite[Prop.~5]{kohel1996endomorphism}. Therefore $[\sO_K : \sO_j]$ divides $\prod_{i=1}^{j}q_i$. Recall from \cite[Prop.~7.20]{cox2011primes} that ideals of $\sO_j$ that are prime to $f_j$ are in bijection with primes of $\sO_K$ avoiding $f_j$. In particular, there is no prime of $\sO_{j-1}$ of norm $q_j$. So $\ker\pi_j$ is not an ideal subgroup \cite[Prop.~23]{kani2011products}. Then by Theorem~\ref{thm:kani-20b}, $[\sO_{j-1} : \sO_j] = q_j$. It follows that $[\sO_K : \sO_n] = \prod_{i=1}^n q_i$ as required.
\end{proof}

\begin{lemma}\label{lem:c-subgps-distinct-quotients}
  Suppose $E$ is an elliptic curve over an algebraically closed field, and $\End E \cong \sO_K$ for some imaginary quadratic field $K$ with $\sO_K^\times = \{\pm 1\}$. Let $q$ be a prime not equal to the characteristic of the base field and inert in $K$. If $\alpha,\beta \in \sO_K$ are prime to $q$, then $E/\alpha(\sC) \approx E/\beta(\sC)$ if and only if $\alpha(\sC) = \beta(\sC)$.
\end{lemma}
\begin{proof}
  Note that $\alpha(\sC) = (\alpha\overline{\beta})(\beta(\sC))$ so up to replacing $\sC$ with $\beta(\sC)$ and $\alpha$ with $\alpha\overline{\beta}$, it is enough to prove the claim for $\beta = 1$.

  If $\alpha(\sC) = \sC$, then $E/\alpha(\sC) \approx E/\sC$, so it suffices to show the other direction. Let $\tilde{u}: E/\alpha(\sC) \to E/\sC$ be an isomorphism. We want to show that $\sC = \alpha(\sC)$.

  Let $\pi_{\sC}$ denote the quotient map $E \to E/\sC$. Note that $\alpha$ induces an isogeny $\tilde{\alpha}: E/\sC \to E/\alpha(\sC)$ defined by the equation $\tilde{\alpha}\circ\pi_{\sC} = \pi_{\alpha(\sC)} \circ \alpha$. The map $\tilde{u}\circ\tilde{\alpha}$ is an endomorphism of $E/\sC$. By Lemma~\ref{lem:c-end}, $\tilde{u}\circ\tilde{\alpha}$ is induced by some $\alpha' \in \sO_K$ that fixes $\sC$. That is, $\pi_{\sC}\circ\alpha' = \tilde{u}\circ\tilde{\alpha}\circ\pi_{\sC} = \tilde{u}\circ\pi_{\alpha(\sC)}\circ\alpha$.
  %This shows that $\deg(\alpha) = \deg(\alpha')$.
  Since $\alpha$ and $\alpha'$ are prime to $q$,
  \[
    \sC + \ker(\alpha')
    \cong
    \ker(\pi_{\sC} \circ \alpha')
    =
    \ker(\tilde{u}\circ\pi_{\sC}\circ\alpha)
    =
    \ker(\pi_{\sC}\circ\alpha)
    \cong
    \sC + \ker(\alpha).
  \]
  Therefore $\ker(\alpha) = \ker(\alpha')$, so $\alpha' = \alpha\circ u$ for some $u \in \sO_K^\times$. By hypothesis, $u = \pm 1$. So $\alpha(\sC) = \pm\alpha'(\sC) = \pm\sC = \sC$.

  %Alternate proof of existence of u: $E/\alpha(\sC)$ and $E/\sC$ have a unique ascending isogeny. As $\tilde{u}$ is an isomorphism, it must send the ascending kernel of $E/\alpha(\sC)$ to that of $E/\sC$. The ascending kernel is the image of $E[c]$ under the quotient. Therefore $\pi^{\vee}\circ\tilde{u}\circ\pi_{\alpha(\sC)}$ is divisible by $c$, and so factors through an automorphism of $E$.
\end{proof}

\begin{lemma}\label{lem:prod-equiv-torsor}
  Suppose $E$ is an elliptic curve over an algebraically closed field, and $\End E \cong \sO_K$ for some imaginary quadratic field $K$ with $\sO_K^\times = \{\pm 1\}$. Let $q$ be a prime not equal to the characteristic of the base field and inert in $K$. Let $\sC$ be a subgroup of $E$ of order $q$. If $\alpha_1,\dots,\alpha_g,\beta_1,\dots,\beta_g \in \sO_K$ are prime to $q$, then
  \[
    \prod_{i=1}^g E/\alpha_i(\sC) \approx \prod_{i=1}^g E/\beta_i(\sC)
    \,\Leftrightarrow\,
    \prod_{i=1}^g \alpha_i \equiv \prod_{i=1}^g \beta_i \text{ in } \Gt_q.
  \]
\end{lemma}
\begin{proof}
  Let $\alpha = \prod_{i=1}^g\alpha_i$ and $\beta = \prod_{i=1}^g\beta_i$. Let $M$ be the diagonal matrix with diagonal entries $\alpha_1^{-1},\dots,\alpha_{g-1}^{-1}, \alpha_g^{-1}\alpha$. Note that $M\mod{c\sO_K} \in \Sl_g(\sO_K/q\sO_K)$. By \cite[Cor.~5.2, Pg.~18]{ktheory1964bass}, we can find $M' \in \Sl_g(\sO_K)$ such that $M \equiv M' \mod{q\sO_K}$. The matrix $M'$ corresponds to an automorphism of $E^g$ sending $\prod_{i=1}^g \alpha_i(\sC)$ to $\sC^{g-1} \times \left(\prod_{i=1}^g \alpha_i\right)(\sC)$. A similar construction with $\beta$ shows that
  \[
    \prod_{i=1}^g E/\alpha_i(\sC) \approx \prod_{i=1}^g E/\beta_i(\sC)
    \,\Leftrightarrow\,
    \left(E/\sC\right)^{g-1} \times E/\alpha(\sC) \approx \left(E/\sC\right)^{g-1} \times E/\beta(\sC).
  \]

  Note that $\alpha$ induces an isogeny $\tilde{\alpha}: E/\sC \to E/\alpha(\sC)$. Let $\sO = \Z + q\sO_K$, which by Lemma~\ref{lem:c-end} is isomorphic to $\End(E/\sC)$, $\End(E/\alpha(\sC))$, and $\End(E/\beta(\sC))$. Thus $\ker\tilde{\alpha}$ is an ideal subgroup by Theorem~\ref{thm:kani-20b}. The same holds for $\beta$ as well.

  %I(\phi) = \{f \in \End E/\sC \colon \ker f \supseteq \ker \phi \}
  For an isogeny $\phi$ with domain $E/\sC$, let $I_\phi$ denote the kernel ideal of $\ker(\phi)$, i.e. $I_\phi = \{f \in \End(E/\sC) \colon f(\ker(\phi)) = 0\}$.
  By \cite[Thm.~46]{kani2011products},
  \begin{align*}
    \left(E/\sC\right)^{g-1} \times E/\alpha(\sC) \approx \left(E/\sC\right)^{g-1} \times E/\beta(\sC)
    \\
    \Leftrightarrow
    \left(\bigoplus_{i=1}^{g-1} \sO\right) \oplus I_{\tilde{\alpha}} \cong \left(\bigoplus_{i=1}^{g-1} \sO\right) \oplus I_{\tilde{\beta}},
  \end{align*}
  where the second isomorphism is as $\sO$-modules. By \cite[Thm.~48]{kani2011products} (see also \cite[Rem.~49b]{kani2011products}), the latter isomorphism is equivalent to $I_{\tilde{\alpha}} \cong I_{\tilde{\beta}}$.
  By Theorem~\ref{thm:kani-20b},
  \[
    I_{\tilde{\alpha}} \cong I_{\tilde{\beta}}
    \,\Leftrightarrow\,
    E/\alpha(\sC) \approx E/\beta(\sC).
  \]
  By Lemma~\ref{lem:c-subgps-distinct-quotients},
  \[
    E/\alpha(\sC) \approx E/\beta(\sC)
    \,\Leftrightarrow\,
    \alpha(\sC) = \beta(\sC).
  \]
  By Lemma~\ref{lem:c-torsor}, $\alpha(\sC) = \beta(\sC)$ if and only if $\alpha \equiv \beta$ in $\Gt_q$.
\end{proof}

\begin{lemma}\label{lem:lim-degree}
  Suppose $A,A' \in \detl$, $\det(A) = \ell^n$, and $\det(A') = \ell^m$.
  %M_{g \times g}(\Z)$ be positive definite symmetric matrices such that $\det(A) = \ell^n$ and $\det(A') = \ell^m$ for a prime $\ell$. Let $X_A$ and $X_{A'}$ denote the images of the maps $\psi_A: Y_0(\ell^n) \to \ag$ and $\psi_{A'}: Y_0(\ell^m) \to \ag$.
  Then there exists a sequence $x_i \in Y_0(\ell^n)$ such that
  \[
    \lim_{i \to \infty}\#\left\{ y \in Y_0(\ell^m) \colon \psi_A(x_i) \approx \psi_{A'}(y) \right\} = \infty.
  \]
\end{lemma}
\begin{proof}
  For any imaginary quadratic field $K$ as in Lemma~\ref{lem:silly}, there exist a principal prime $\alpha\sO_K$ lying over $\ell$ and rational primes $q_i$ as in Lemma~\ref{lem:K-exists}. We may assume $q_i \neq \ell$ for all $i$. Let $E$ be an elliptic curve over an algebraically closed field with endomorphism ring $\End(E) \cong \sO_K$.

  If $\sC$ is a cyclic subgroup of $E$ of order prime to $\ell$, then $\alpha$ induces a chain of isogenies
  \[
    E/\sC \to E/\alpha(\sC) \to \cdots \to E/\alpha^n(\sC).
  \]
  Let $\alpha_{\sC,n}: E/\sC \to \cdots \to E/\alpha^n(\sC)$ be the composition of this chain. Then $\alpha_{\sC,n}$ is a cyclic $\ell^n$-isogeny, so the pair $(E/\sC,\alpha_{\sC,n})$ defines a point in $Y_0(\ell^n)$.

    For each $i$, we fix a cyclic subgroup $\sC_i$ of $E$ of order $q_i$. Define $x_1$ to be $(E/\sC_1,\alpha_{\sC_1,n})$, $x_2$ to be $(E/(\sC_1 + \sC_2), \alpha_{\sC_1 + \sC_2,n})$, and similarly for $x_i$. Note that the $x_i$ are distinct points, as the curves all have different endomorphism rings by Lemma~\ref{lem:c-end}.

    Next we will construct the values of $y \in Y_0(\ell^m)$ such that $\psi_{A'}(y) = \psi_{A}(x_i)$. We first focus on the case $i = 1$. By Lemma~\ref{lem:psimod-weakly-isomorphic-to-product}, $\psi_{A}(x_1) \approx E/\alpha^{n_1}(\sC_1) \times \cdots \times E/\alpha^{n_g}(\sC_1)$, where $\ell^{n_1},\dots,\ell^{n_g}$ are the elementary divisors of $A$.
    %By our choice of $K$, $\alpha$ is a $g$th power in $\sO_K/q_1\sO_K$, so we can find $\gamma \in \sO_K$ such that $\alpha \equiv \gamma^g \mod{q_1\sO_K}$. By Lemma~\ref{lem:c-torsor}, $\alpha(\sC_1) = \gamma^g(\sC_1)$ and
%    \[
%      \psi_{A}(x_1) \approx E/\gamma^{gn_1}(\sC_1) \times \cdots \times E/\gamma^{gn_g}(\sC_1).
%    \]
    Let $\ell^{n_1'},\dots,\ell^{n_g'}$ be the elementary divisors of $A'$, and let $S$ denote a set of representatives $\beta \in \sO_K$ of the solutions to the equation
    \[
      \alpha^{n_1 + \cdots + n_g} \equiv \beta^g\alpha^{n_1' + \cdots + n_g'}
      \text{ in } \Gt_{q_1}.
    \]
Since $\alpha$ is a $g$-th power in  $(\sO_K/q_1\sO_K)^\times$, and  $g$ divides the order $q_1 + 1$ of the cyclic group $\Gt_{q_1}$,
   we have $\#S = g$. For all $\beta \in S$, let $y_\beta = (E/\beta(\sC_1),\alpha_{\beta(\sC_1),m})$. By Lemma~\ref{lem:psimod-weakly-isomorphic-to-product}, $\psi_{A'}(y_\beta) = E/\alpha^{n_1'}(\beta(\sC_1)) \times \cdots \times E/\alpha^{n_g'}(\beta(\sC_1))$. Therefore $\psi_A(x_1) \approx \psi_{A'}(y_\beta)$ by Lemma~\ref{lem:prod-equiv-torsor}. Moreover, by Lemma~\ref{lem:c-subgps-distinct-quotients} the $y_\beta$ are distinct. Hence we have found $g$ points $y \in Y_0(\ell^m)$ with $\psi_{A}(x_1) \approx \psi_{A'}(y)$.

  For $x_2$, we use a similar construction. By the Chinese remainder theorem, the set of subgroups of $E$ of order $q_1q_2$ is a torsor over $\Gt_{q_1} \times \Gt_{q_2}$. Finding $\beta$ such that
  \[
    \psi_{A}(x_2) \approx \psi_{A'}\left(E/\beta(\sC_1+\sC_2),\alpha_{\beta(\sC_1+\sC_2),m}\right)
  \]
  reduces to finding solutions $\beta$ to the equation
  \[
    \alpha^{n_1 + \cdots + n_g} \equiv \beta^g\alpha^{n_1' + \cdots + n_g'}
    \text{ in } \Gt_{q_1} \times \Gt_{q_2}.
  \]
%  Here $\gamma$ is chosen such that $\alpha \equiv \gamma^g \mod{q_1q_2\sO_K}$.
There are precisely $g^2$ solutions $\beta$ to this equation. Continuing this construction for $i=3,4,\dots$, we find that for $x_i$ there are $g^i$ points $y \in Y_0(\ell^m)$ such that $\psi_{A}(x_i) \approx \psi_{A'}(y)$.
\end{proof}

\begin{proof}[Proof of Theorem~\ref{thm:Sg-dense}]
  Let $S$ denote the Zariski closure of $\sg(k) \cap (X_A \times X_{A'})$. By Lemma~\ref{lem:lim-degree}, $\sg(k) \cap (X_A \times X_{A'})$ has an infinite number of geometric points. This implies that $\dim S \geq 1$. Suppose the dimension equals $1$, so that $S$ is a finite union of curves $\cup S_i$. The $S_i$ cannot all be horizontal components---that is, of the form $X \times \{z\}$---since this would contradict Lemma~\ref{lem:lim-degree}. Let $S'$ be $V$ with the horizontal components removed. Consider the projection $\pi_X: S' \to X$. Lemma~\ref{lem:lim-degree} implies that this map has unbounded degree. But $\pi_X$ on each irreducible component of $S'$ is nonconstant, and so $\pi_X|_{S'}$ has finite degree, yielding a contradiction. Therefore $\dim S \geq 2$ and the claim follows.
\end{proof}







\section{Proof of Theorem \ref{thm:arbit-char}}
\label{sec:characteristic-p}

Let $A$ be a $g \times g$ diagonal matrix whose diagonal entries are positive integers, and having determinant $N$. Observe that the map $\psimod: Y_0(N) \to \ag$ factors through $\ao^g$, where we consider elements of $\ao^g$ to be products of $g$ elliptic curves with the product polarization. Write
\[
\psidiag: Y_0(N) \to \ao^g
\]
for the associated morphism. Thus, if the diagonal entries of $A$ are $d_1, \ldots, d_g$ and for $(E, C) \in Y_0(N)$, if we define $E_i$ to be $E/(N/d_i)C$, then
\[
  \psidiag(E,C) = E_1 \times \cdots \times E_g.
\]

\begin{theorem}\label{thm:char-p-version}
  The set $\bigcup_A \im\psidiag$ is Zariski dense in $\ao^g$.
\end{theorem}

\begin{proof}
 Let $E_0$ be an elliptic curve with CM by $\sO_K$ for some imaginary quadratic field $K$; such a curve will be defined over any algebraically closed field $k$ containing the base ring $R$. Choose a prime $\ell$ that is inert in $K$ and fix a subgroup $\sC_0$ of $E_0$ of order $\ell$. Let $\pi_0$ denote the quotient map $E_0 \to E_0/\sC_0 =: E_1$. Note that by Theorem~\ref{thm:kani-20b}, since $\sC_0$ is not a kernel ideal of $E_0$, it follows that $\End E_1 \cong \Z + \ell\sO_K$.

 For $i \ge 1$, let $\sC_i$ be any subgroup of $E_i$ of order $\ell$ other than $\pi_{i-1}(\sC_{i-1})$, and let $\pi_i$ be the quotient map $E_i \to E_i/\sC_i =: E_{i+1}$. Again, we have that $\End E_{i+1} \cong \Z + \ell^{i+1}\sO_{i}$. This is because $\End E_{i}$ has exactly one ideal of norm $\ell$ given by $\ell\End E_{i-1}$. This ideal corresponds to the dual of $\pi_{i-1}$. Hence $\ker\pi_i$ is not an ideal subgroup so the endomorphism ring of $E_{i+1}$ must be strictly smaller by Theorem~\ref{thm:kani-20b}.

 For all $n \in \Z_{\ge 1}$, the composition $\pi^{(n)} = \pi_{n-1} \circ \cdots \circ \pi_0$ is a cyclic $\ell^n$-isogeny on $E$. To see this, note that if $\ker\pi^{(n)}$ was not cyclic, then $\pi^{(n)}$ would factor into a composition of the form $\psi\circ[\ell^m]$, where $[\ell^m]$ is the multiplication by $\ell^m$ map. However, the index of $\End E_n$ in $\sO_K$ is then bounded by $\deg\psi$. By above, $\End E_n$ has index $\ell^n = \deg\pi^{(n)}$ and therefore we must have that $m = 0$.

 Let $S = \{E_i\}_{i=0}^\infty$. Let $(E_{n_1},\dots,E_{n_g}) \in S$ and let $A$ be the diagonal matrix with diagonal entries $\ell^{n_1},\dots,\ell^{n_g}$.  Choose any $n > \max\{n_i\}$, and let $\sC = \ker \pi^{(n)}$. Then $(E_0,\pi^{(n)}) \in Y_0(\ell^n)$ and
 \[
   \psidiag(E_0,\sC) = E_{n_1} \times \cdots \times E_{n_g}.
 \]
Thus, $S \subset \bigcup\psidiag(Y_0(\ell^n))$. Since $S$ is an infinite set of non-isomorphic elliptic curves, $S$ is dense in $\ao$. Therefore $S^g$ is dense in $\ao^g$.
\end{proof}










\section{Proof of Theorem~\ref{thm:curves-dense}}

\begin{lemma}\label{lem:sl-dense}
  If $N$ is a positive integer, then $\Sl_g(\Z[1/N])$ is dense in $\Sl_g(\R)$.
\end{lemma}
\begin{proof}
  Let $G \in \Sl_g(\R)$. Factor $G$ as a product of elementary matrices $G = E_n \cdots E_2 E_1$, where $\det E_i = \pm 1$. For each $E_i$, with at most one exception the entries are $0$ or $\pm 1$. Thus there exists a $g \times g$ matrix $E_i'$ with entries in $\Z[1/N]$ and $\det E_i' = \det E_i$ that is arbitrarily close to $E_i$. Let $G' = E_n' \cdots E_1' \in \Sl_g(\Z[1/N])$. Since matrix multiplication is continuous, $G'$ is close to $G$.
\end{proof}

\begin{lemma}\label{lem:rggt-dense}
  If $N$ is a positive integer, then the set
\[
\{ rGG^t \colon r \in \R^+ \text{ and } G \in \Sl_g(\Z[1/N]) \}
\]
is dense in the set of real, symmetric, positive definite matrices.
\end{lemma}
\begin{proof}
  Let $A$ be a real, symmetric, positive definite matrix. Then there exists an orthogonal matrix $O$ such that $D = OAO^t$ is diagonal and has positive entries. Let $H = \det(D)^{-1/2}O\sqrt{D}$ so that $A = \det(D)HH^t$. Note that $H \in \Sl_g(\R)$, so by Lemma~\ref{lem:sl-dense}, we can find $G \in \Sl_g(\Z[1/N])$ arbitrarily close to $H$, and therefore we can make $\det(D)GG^t$ arbitrarily close to $A$.
\end{proof}

\begin{definition}
  A $g \times g$ matrix $Q$ is \emph{half-integral} if $2Q_{ij} \in \Z$ and $Q_{ii} \in \Z$ for all $1 \leq i,j \leq g$, where $Q_{ij}$ denotes the $i,j$ entry of $Q$.
\end{definition}

\begin{lemma}\label{lem:finite-fixed-trace}
 Fix $t\in\R$. Then there are finitely many $g \times g$ symmetric, positive semi-definite, half-integral matrices $Q$ such that $\tr(Q) \leq t$.
\end{lemma}
\begin{proof}
  Suppose $Q$ is a symmetric, positive semi-definite, half-integral matrix with $\tr(Q) \leq t$. Let $\lambda_1,\dots,\lambda_g$ be the eigenvalues of $Q$. Since $\lambda_i \geq 0$, we have
  \[
    \sum_{1 \leq i,j \leq g} (Q_{ij})^2 = \tr(Q^2) = \sum \lambda_i^2 \leq \left(\sum \lambda_i\right)^2 = \tr(Q)^2 \leq t^2.
  \]
  This shows that $Q$, as a vector in $\R^{g^2}$, lies in the ball of radius $t$. Thus the number of possible $Q$ is bounded by the number of half-integral points in the ball of radius $t$ in $\R^{g^2}$, which is finite.
\end{proof}

% \begin{lemma}\label{lem:bound-trace-finite}
%  For any positive definite symmetric real $g \times g$ matrix $A$ and $t \in \R$, the set of symmetric, positive semi-definite, half-integral $g \times g$ matrices $Q$ such that $\tr(AQ) \leq t$ is finite.
% \end{lemma}
% \begin{proof}
%  Recall that $\langle x,y \rangle = \tr(xy^t)$ is an inner product on the space of real matrices. Moreover, if $B$ is any positive semidefinite matrix, then $\tr(B^2) \leq \tr(B)^2$. So
%  \begin{align*}
%    \tr(BQ)^2 &\leq \tr(B^2)\tr(Q^2)
%    &&\text{by Cauchy–Schwarz}
%    \\
%    &\leq \tr(B)^2\tr(Q)^2
%    &&\text{By positive semidefinite.}
%    %\tr(B^2) = \sum \lambda_i^2 \leq \left(\sum \lambda_i\right)^2 = \tr(B)^2.
%  \end{align*}
%  Therefore, if $\tr(AQ) \leq t$, then
%  \[
%    \tr(Q) = \tr(A^{-1}AQ) \leq \tr(A^{-1})\tr(AQ) \leq \tr(A^{-1})t.
%  \]
%  The claim then follows from Lemma~\ref{lem:finite-fixed-trace}.
% \end{proof}

\begin{lemma}\label{lem:unique-minimizer}
  Suppose $S$ is a nonempty set of symmetric, positive semi-definite, half-integral $g \times g$ matrices. Then there exists an open cone of positive definite, real, symmetric, $g \times g$ matrices $A$ such that $\displaystyle\min_{Q \in S}\tr(AQ)$ is achieved by a unique $Q\in S$.
\end{lemma}
\begin{proof}
Let $t_0 = \displaystyle\min_{Q \in S}\tr(Q)$.
  Since $\{Q \in S \colon \tr(Q) \leq t\}$ is finite for all $t \in \R$ by Lemma~\ref{lem:finite-fixed-trace},
  there is a gap between $t_0$ and the next smallest value $t_1$ of $\tr(Q)$ for $Q \in S$. Let $S_0 = \{Q \in S \colon \tr(Q) = t_0\}$.

  Let $\mathfrak{S}$ be the set of real symmetric matrices $E$ such that
  \begin{enumerate}
    \item $\tr(EQ_i) \neq \tr(EQ_j)$ for all distinct $Q_i,Q_j \in S_0$,
    \item $I+E$ is positive definite, and
    \item $\tr(EQ) < t_1 - t_0$.
  \end{enumerate}
  Condition (3) implies that $\tr((I+E)Q)$ is minimized only when $Q \in S_0$. Hence by condition (1) we have that $\tr((I+E)Q)$ is minimized for a unique $Q \in S$. As $I+E$ is positive definite, the matrix $A = I + E$ satisfies the conclusion of the lemma. Moreover, $rA$ also satisfies the conclusion for all $r \in \R^+$, so $I + \mathfrak{S}$ is a cone.

  It remains to show that $I + \mathfrak{S}$ is open (in the space of real symmetric matrices) and non-empty. It is open because $\mathfrak{S}$ is defined as a finite intersection of open subsets. To see that $\mathfrak{S}$ is non-empty, observe that property (i) describes the complement of a finite union of hyperplanes, which is a dense set. Therefore we can find some $E$ simultaneously satisfying properties (i) and (ii). By scaling by a sufficiently small $\varepsilon > 0$, we can guarantee property (iii) as well, and hence $\varepsilon E \in \mathfrak{S}$.
\end{proof}

\begin{proof}[Proof of Theorem~\ref{thm:curves-dense}]
  Our goal is to show that $\cup X_A$ is Zariski dense in $\ag$. The claim is trivial when $g = 1$, so we will assume $g \geq 2$. It is sufficient to show that for all non-zero Siegel modular functions $f: \ag \to k$, there exists some $A \in \detl$ such that the pull back $f \circ \psimod$ is non-zero.

  Let $f$ be a Siegel modular function on $\ag$, viewed as a global section of the structure sheaf. Recall that $f$ admits a $q$-expansion of the form $f = \sum_Q c_Q q^{\tr(Q)}$ where $Q$ ranges over all symmetric half-integral positive semi-definite matrices \cite[Prop. V.1.5]{faltings1990degeneration}.

  Let $S$ denote the set of $Q$ such that $c_Q \neq 0$; that is, $S$ is the support of $f$. By Lemma~\ref{lem:unique-minimizer} applied to the set $S$, there is an open cone $U$ of real, symmetric, positive definite matrices $A$ such that $\tr(AQ)$ is minimized by a unique $Q$.

  By Lemma~\ref{lem:rggt-dense}, we can find some $A \in U$ of the form $A = rGG^t$ with $r \in \R^+$ and $G \in \Sl_g(\Z[1/\ell])$. As $U$ is a cone, we may scale $A$ and assume that $r$ is a power of $\ell$ so that $A \in \detl$.

  Let $n = \min \{\tr(AQ) \colon Q \in S\}$. Then there is a unique $Q_0 \in S$ such that $\tr(AQ_0) = n$. % If $k = \C$, one has that the $q$-expansion of $f \circ \psimod$ is $\sum_Q c_Q q^{\tr(AQ)}$. By functoriality, this holds when $k$ is an arbitrary algebraically closed field.
  Since $q$-expansions interact
  with modular morphisms as expected, we have that the $q$-expansion of $f \circ \psimod$ is $\sum_Q c_Q q^{\tr(AQ)}$.   By construction, the coefficient of $q^n$ is $c_{Q_0} \neq 0$. Hence $f \circ \psimod \neq 0$.
\end{proof}







\bibliographystyle{halpha}
\bibliography{./references}

\end{document}
